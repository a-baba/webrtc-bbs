!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.WebRtcBbs=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){(function(global){__browserify_shim_require__=_dereq_;(function browserifyShim(module,exports,_dereq_,define,browserify_shim__define__module__export__){(function(e,t){typeof define=="function"&&define.amd?define([],t):e.Chord=t()})(this,function(){var e,t,n;return function(r){function v(e,t){return h.call(e,t)}function m(e,t){var n,r,i,s,o,u,a,f,c,h,p,v=t&&t.split("/"),m=l.map,g=m&&m["*"]||{};if(e&&e.charAt(0)===".")if(t){v=v.slice(0,v.length-1),e=e.split("/"),o=e.length-1,l.nodeIdCompat&&d.test(e[o])&&(e[o]=e[o].replace(d,"")),e=v.concat(e);for(c=0;c<e.length;c+=1){p=e[c];if(p===".")e.splice(c,1),c-=1;else if(p===".."){if(c===1&&(e[2]===".."||e[0]===".."))break;c>0&&(e.splice(c-1,2),c-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((v||g)&&m){n=e.split("/");for(c=n.length;c>0;c-=1){r=n.slice(0,c).join("/");if(v)for(h=v.length;h>0;h-=1){i=m[v.slice(0,h).join("/")];if(i){i=i[r];if(i){s=i,u=c;break}}}if(s)break;!a&&g&&g[r]&&(a=g[r],f=c)}!s&&a&&(s=a,u=f),s&&(n.splice(0,u,s),e=n.join("/"))}return e}function g(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function y(e){return function(t){return m(t,e)}}function b(e){return function(t){a[e]=t}}function w(e){if(v(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!v(a,e)&&!v(c,e))throw new Error("No "+e);return a[e]}function E(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function S(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice,d=/\.js$/;o=function(e,t){var n,r=E(e),i=r[0];return e=r[1],i&&(i=m(i,t),n=w(i)),i?n&&n.normalize?e=n.normalize(e,y(t)):e=m(e,t):(e=m(e,t),r=E(e),i=r[0],e=r[1],i&&(n=w(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return g(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:S(e)}}},i=function(e,t,n,i){var s,l,h,p,d,m=[],y=typeof n,E;i=i||e;if(y==="undefined"||y==="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(d=0;d<t.length;d+=1){p=o(t[d],i),l=p.f;if(l==="require")m[d]=u.require(e);else if(l==="exports")m[d]=u.exports(e),E=!0;else if(l==="module")s=m[d]=u.module(e);else if(v(a,l)||v(f,l)||v(c,l))m[d]=w(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,g(i,!0),b(l),{}),m[d]=a[l]}}h=n?n.apply(a[e],m):undefined;if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!E)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){if(typeof e=="string")return u[e]?u[e](t):w(o(e,t).f);if(!e.splice){l=e,l.deps&&s(l.deps,l.callback);if(!t)return;t.splice?(e=t,t=n,n=null):e=r}return t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s},s.config=function(e){return s(e)},e._defined=a,n=function(e,t,n){t.splice||(n=t,t=[]),!v(a,e)&&!v(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("lib/almond",function(){}),n("lodash",[],function(){return _}),n("cryptojs",[],function(){return CryptoJS}),n("Utils",["lodash"],function(e){var t={version:[1,0,0],isNonemptyString:function(t){return e.isString(t)&&!e.isEmpty(t)},isValidNumber:function(t){return!e.isNaN(t)&&e.isNumber(t)},isPositiveNumber:function(e){return t.isValidNumber(e)&&e>0},isZeroOrPositiveNumber:function(e){return e===0||t.isPositiveNumber(e)},insert:function(e,t,n){e.splice(t,0,n)},generateRandomId:function(e){var t="";while(t.length<e)t+=Math.random().toString(36).substr(2);return t.substr(0,e)},enableDebugLog:function(e){t.debug=function(){if(e){var t=Array.prototype.slice.call(arguments),n=new Date,r=[n.getHours(),n.getMinutes(),n.getSeconds()].join(":")+":";t.unshift(r),console.log.apply(console,t)}}},debug:function(){}},n=function(t,n){var r=this;this._items=[],this._comparator=n,e.each(t,function(e){r.put(e)})};n.prototype={put:function(e){(this.size()===0||!this.has(e))&&this._items.push(e)},remove:function(t){var n=this;this._items=e.reject(this._items,function(e){return n._comparator(e,t)})},size:function(){return e.size(this._items)},has:function(t){var n=this;return e.some(this._items,function(e){return n._comparator(e,t)})},items:function(){return this._items}},t.Set=n;var r=function(){this._items=[]};r.prototype={enqueue:function(e){this._items.push(e)},dequeue:function(){return e.isEmpty(this._items)?null:this._items.shift()},first:function(){return e.isEmpty(this._items)?null:e.first(this._items)},last:function(){return e.isEmpty(this._items)?null:e.last(this._items)},size:function(){return e.size(this._items)}},t.Queue=r;var i=function(e,t){this._cache={},this._useHistory=[],this._capacity=e,this._cacheOutCallback=t};return i.prototype={get:function(t){return e.has(this._cache,t)?(this._updateUseHistory(t),this._cache[t]):null},set:function(t,n){var r=this;this._cache[t]=n,this._updateUseHistory(t);if(e.size(this._cache)>this._capacity){var i=e.rest(this._useHistory,this._capacity);this._useHistory=e.first(this._useHistory,this._capacity),e.each(i,function(e){var t=r._cache[e];delete r._cache[e],r._cacheOutCallback(t)})}},remove:function(t){if(!this.has(t))return;this._useHistory=e.reject(this._useHistory,function(e){return e===t}),delete this._cache[t]},has:function(t){return e.has(this._cache,t)},keys:function(){return e.keys(this._cache)},_updateUseHistory:function(t){this._useHistory=e.reject(this._useHistory,function(e){return e===t}),this._useHistory.unshift(t)}},t.Cache=i,t}),n("ID",["lodash","cryptojs","Utils"],function(e,t,n){var r=function(t){e.each(t,function(t){if(e.isNaN(t)||!e.isNumber(t)||t<0||255<t)throw new Error("Invalid argument.")});if(t.length!==r._BYTE_SIZE)throw new Error("Invalid argument.");this._bytes=e.last(t,r._BYTE_SIZE),this._hexString=e.map(this._bytes,function(e){var t=e.toString(16);return e<16?"0"+t:t}).join("")};return r._BYTE_SIZE=32,r._BIT_LENGTH=r._BYTE_SIZE*8,r.create=function(e){if(!n.isNonemptyString(e))throw new Error("Invalid argument.");return new r(r._createBytes(e))},r._createBytes=function(e){var n=t.SHA256(e).toString(t.enc.Hex);return r._createBytesFromHexString(n)},r._createBytesFromHexString=function(t){if(!n.isNonemptyString(t)||t.length<r._BYTE_SIZE*2)throw new Error("Invalid argument.");return e(r._BYTE_SIZE).times(function(e){return parseInt(t.substr(e*2,2),16)}).value()},r.fromHexString=function(e){return new r(r._createBytesFromHexString(e))},r._addInBytes=function(t,n){var r=e.clone(t),i=0;for(var s=t.length-1;s>=0;s--)r[s]+=n[s]+i,r[s]<0?(i=-1,r[s]+=256):i=r[s]>>8,r[s]&=255;return r},r.prototype={isInInterval:function(e,t){if(!e||!t)throw new Error("Invalid arguments.");return e.equals(t)?!this.equals(e):e.compareTo(t)<0?this.compareTo(e)>0&&this.compareTo(t)<0:this.compareTo(e)>0||this.compareTo(t)<0},addPowerOfTwo:function(t){if(t<0||t>=r._BIT_LENGTH)throw new Error("Power of two out of index.");var n=e.clone(this._bytes),i=this._bytes.length-1-Math.floor(t/8),s=[1,2,4,8,16,32,64,128][t%8];for(var o=i;o>=0;o--){n[o]+=s,s=n[o]>>8,n[o]&=255;if(s===0)break}return new r(n)},add:function(e){return new r(r._addInBytes(this._bytes,e._bytes))},sub:function(t){return new r(r._addInBytes(this._bytes,e.map(t._bytes,function(e){return-e})))},getIntervalInPowerOfTwoFrom:function(e){if(this.equals(e))return-Infinity;var t=this.sub(e);for(var n=0;n<r._BIT_LENGTH;n++)if(r._powerOfTwos[n].compareTo(t)>0){if(n===0)return-Infinity;break}return n-1},compareTo:function(e){for(var t=0;t<r._BYTE_SIZE;t++){if(this._bytes[t]<e._bytes[t])return-1;if(this._bytes[t]>e._bytes[t])return 1}return 0},equals:function(e){return this.compareTo(e)===0},getLength:function(){return r._BIT_LENGTH},toHexString:function(){return this._hexString}},r.minId=new r(e(r._BYTE_SIZE).times(function(){return 0}).value()),r.maxId=new r(e(r._BYTE_SIZE).times(function(){return 255}).value()),r._powerOfTwos=e(r.minId.getLength()).times(function(e){return r.minId.addPowerOfTwo(e)}).value(),r}),n("Response",["lodash","Utils"],function(e,t){var n=function(n,r,i,s,o,u){if(n[0]!==t.version[0])throw new Error("Cannot communicate with version "+n.join(".")+" (your version is "+t.version.join(".")+")");if(!t.isNonemptyString(r)||!t.isNonemptyString(i)||!e.isObject(s)||!t.isNonemptyString(o)||!e.isNumber(u))throw new Error("Invalid argument.");this.version=n,this.status=r,this.method=i,this.result=s,this.requestId=o,this.timestamp=u};return n.create=function(r,i,s){return new n(t.version,r,s.method,i,s.requestId,e.now())},n.isResponse=function(n){return e.isObject(n)?t.isNonemptyString(n.status)?!0:!1:!1},n.fromJson=function(t){if(!e.isObject(t))throw new Error("Invalid argument.");return new n(t.version,t.status,t.method,t.result,t.requestId,t.timestamp)},n.prototype={toJson:function(){return{version:this.version,status:this.status,method:this.method,result:this.result,requestId:this.requestId,timestamp:this.timestamp}}},n}),n("Request",["lodash","cryptojs","Response","Utils"],function(e,t,n,r){var i=function(t,n,i,s,o){if(t[0]!==r.version[0])throw new Error("Cannot communicate with version "+t.join(".")+" (your version is "+r.version.join(".")+")");if(!r.isNonemptyString(n)||!e.isObject(i)||!r.isNonemptyString(s)||!e.isNumber(o))throw new Error("Invalid argument.");this.version=t,this.method=n,this.params=i,this.requestId=s,this.timestamp=o};return i.create=function(t,n){return new i(r.version,t,n,r.generateRandomId(8),e.now())},i.isRequest=function(e){return!n.isResponse(e)},i.fromJson=function(t){if(!e.isObject(t))throw new Error("Invalid argument.");return new i(t.version,t.method,t.params,t.requestId,t.timestamp)},i.prototype={toJson:function(){return{version:this.version,method:this.method,params:this.params,requestId:this.requestId,timestamp:this.timestamp}}},i}),n("Entry",["lodash","ID"],function(e,t){var n=function(t,n){if(e.isNull(t)||e.isUndefined(n))throw new Error("Invalid argument.");this.id=t,this.value=n};return n.fromJson=function(r){if(!e.isObject(r))throw new Error("invalid argument.");return new n(t.fromHexString(r.id),r.value)},n.prototype={equals:function(t){return t instanceof n?this.id.equals(t.id)&&e.isEqual(this.value,t.value):!1},toJson:function(){return{id:this.id.toHexString(),value:this.value}}},n}),n("Node",["lodash","ID","Request","Entry","Utils"],function(e,t,n,r,i){var s=function(e,n,r,o,u){if(!s.isValidNodeInfo(e))throw new Error("Invalid arguments.");i.isZeroOrPositiveNumber(u.requestTimeout)||(u.requestTimeout=18e4),this._peerId=e.peerId,this.nodeId=t.create(e.peerId),this._nodeFactory=n,this._connectionFactory=r,this._requestHandler=o,this._config=u};return s.isValidNodeInfo=function(t){return e.isObject(t)?i.isNonemptyString(t.peerId)?!0:!1:!1},s.prototype={findSuccessor:function(e,n){var r=this;if(!(e instanceof t)){n(null);return}this._sendRequest("FIND_SUCCESSOR",{key:e.toHexString()},{success:function(e){var t=e.successorNodeInfo;r._nodeFactory.create(t,n)},redirect:function(t){r._nodeFactory.create(t.redirectNodeInfo,function(t,r){if(r){n(null,r);return}i.debug("[findSuccessor] redirected to "+t.getPeerId()),t.findSuccessor(e,n)})},error:function(e){n(null,e)}})},notifyAndCopyEntries:function(t,n){var i=this;this._sendRequest("NOTIFY_AND_COPY",{potentialPredecessorNodeInfo:t.toNodeInfo()},{success:function(t){if(!e.isArray(t.referencesNodeInfo)||!e.isArray(t.entries)){n(null,null);return}i._nodeFactory.createAll(t.referencesNodeInfo,function(i){var s=e.chain(t.entries).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();n(i,s)})},error:function(e){n(null,null,e)}})},notify:function(t,n){var r=this;this._sendRequest("NOTIFY",{potentialPredecessorNodeInfo:t.toNodeInfo()},{success:function(t){if(!e.isArray(t.referencesNodeInfo)){n(null);return}r._nodeFactory.createAll(t.referencesNodeInfo,function(e){n(e)})},error:function(e){n(null,e)}})},leavesNetwork:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");this._sendRequest("LEAVES_NETWORK",{predecessorNodeInfo:t.toNodeInfo()})},ping:function(e){this._sendRequest("PING",{},{success:function(t){e()},error:function(t){e(t)}})},insertReplicas:function(t){this._sendRequest("INSERT_REPLICAS",{replicas:e.invoke(t,"toJson")})},removeReplicas:function(t,n){this._sendRequest("REMOVE_REPLICAS",{sendingNodeId:t.toHexString(),replicas:e.invoke(n,"toJson")})},insertEntry:function(e,t){var n=this;this._sendRequest("INSERT_ENTRY",{entry:e.toJson()},{success:function(e){t()},redirect:function(r){n._nodeFactory.create(r.redirectNodeInfo,function(n,r){if(r){t(r);return}i.debug("[insertEntry] redirected to "+n.getPeerId()),n.insertEntry(e,t)})},error:function(e){t(e)}})},retrieveEntries:function(t,n){var s=this;this._sendRequest("RETRIEVE_ENTRIES",{id:t.toHexString()},{success:function(t){if(!e.isArray(t.entries)){n(null,new Error("Received invalid data from "+s._peerId));return}var i=e.chain(t.entries).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();n(i)},redirect:function(e){s._nodeFactory.create(e.redirectNodeInfo,function(e,r){if(r){n(null,r);return}i.debug("[retrieveEntries] redirected to "+e.getPeerId()),e.retrieveEntries(t,n)})},error:function(e){n(null,e)}})},removeEntry:function(e,t){var n=this;this._sendRequest("REMOVE_ENTRY",{entry:e.toJson()},{success:function(e){t()},redirect:function(r){n._nodeFactory.create(r.redirectNodeInfo,function(n,r){if(r){t(r);return}i.debug("[removeEntry] redirected to "+n.getPeerId()),n.removeEntry(e,t)})},error:function(e){t(e)}})},sendMessage:function(e){this._sendRequest("UPPER_LAYER_MESSAGE",{message:e})},_sendRequest:function(t,r,s){var o=this;this._connectionFactory.create(this._peerId,function(u,a){if(a){s&&s.error&&s.error(a);return}var f=n.create(t,r);if(s){s=e.defaults(s,{success:function(){},redirect:function(){},error:function(){}});var l=setTimeout(function(){o._nodeFactory.deregisterCallback(f.requestId),s.error(new Error(t+" request to "+o._peerId+" timed out."))},o._config.requestTimeout);o._nodeFactory.registerCallback(f.requestId,e.once(function(e){clearTimeout(l);switch(e.status){case"SUCCESS":s.success(e.result);break;case"REDIRECT":s.redirect(e.result);break;case"FAILED":s.error(new Error("Request to "+o._peerId+" failed: "+e.result.message));break;default:callback.error(new Error("Received unknown status response:",e.status))}}))}i.debug("Sending request to",o._peerId,":",f.method);try{u.send(f)}finally{u.close()}})},onRequestReceived:function(e){var t=this;i.debug("Received request from",this._peerId,":",e.method),this._requestHandler.handle(this._peerId,e,function(e){t._connectionFactory.create(t._peerId,function(n,r){if(r){console.log(r);return}i.debug("Sending response to",t._peerId,":",e.method);try{n.send(e)}finally{n.close()}})})},onResponseReceived:function(t){i.debug("Received response from",this._peerId,":",t.method,"(",t.status,")");var n=this._nodeFactory.deregisterCallback(t.requestId);e.isNull(n)||n(t)},disconnect:function(){this._connectionFactory.removeConnection(this._peerId)},getPeerId:function(){return this._peerId},toNodeInfo:function(){return{nodeId:this.nodeId.toHexString(),peerId:this._peerId}},equals:function(t){return e.isNull(t)?!1:this.nodeId.equals(t.nodeId)},toString:function(){return this.nodeId.toHexString()+" ("+this._peerId+")"}},s}),n("peerjs",[],function(){return Peer}),n("PeerAgent",["lodash","peerjs","Utils"],function(e,t,n){var r=function(r,i){var s=this;e.isObject(r.peer)||(r.peer={id:undefined,options:{}}),e.isObject(r.peer.options)||(r.peer.options={}),n.isZeroOrPositiveNumber(r.connectRateLimit)||(r.connectRateLimit=3e3),n.isZeroOrPositiveNumber(r.connectionOpenTimeout)||(r.connectionOpenTimeout=3e4),e.isString(r.peer.id)?this._peer=new t(r.peer.id,r.peer.options):this._peer=new t(r.peer.options),this._config=r,this._callbacks=i,this._waitingTimer=null;var o=e.once(i.onPeerSetup);this._peer.on("open",function(e){n.debug("Peer opend (peer ID:",e,")"),s._peer.on("connection",function(e){n.debug("Connection from",e.peer),e.on("open",function(){i.onConnection(e.peer,e)})}),s._peer.on("close",function(){n.debug("Peer closed."),i.onPeerClosed()}),o(e)}),this._peer.on("error",function(e){n.debug("Peer error:",e);var t=e.message.match(/Could not connect to peer (\w+)/);if(t){if(!s.isWaitingForOpeningConnection())return;clearTimeout(s._waitingTimer),s._waitingTimer=null;var r=t[1];i.onConnectionOpened(r,null,e);return}console.log(e),o(null,e)})};return r.prototype={connect:function(e){var t=this;if(this.isWaitingForOpeningConnection())throw new Error("Invalid state.");var r=this._peer.connect(e,{serialization:"json"});if(!r){var i=new Error("Failed to open connection to "+e+".");this._callbacks.onConnectionOpened(e,null,i);return}this._waitingTimer=setTimeout(function(){if(!t.isWaitingForOpeningConnection())return;t._waitingTimer=null;var n=new Error("Opening connection to "+e+" timed out.");t._callbacks.onConnectionOpened(e,null,n)},this._config.connectionOpenTimeout),r.on("open",function(){n.debug("Connection to",r.peer,"opened.");if(!t.isWaitingForOpeningConnection()){console.log("Unexpected opening connection."),r.close();return}clearTimeout(t._waitingTimer),t._waitingTimer=null,t._callbacks.onConnectionOpened(e,r)})},isWaitingForOpeningConnection:function(){return!e.isNull(this._waitingTimer)},destroy:function(){this._peer.destroy()},getPeerId:function(){return this._peer.id},listAllPeers:function(e){this._peer.listAllPeers(e)}},r}),n("Packet",["lodash","cryptojs","Utils"],function(e,t,n){var r=function(t,r,i){if(!n.isNonemptyString(t)||!e.isObject(r)||!e.isObject(i))throw new Error("Invalid argument.");this.id=t,this.flags=r,this.payload=i};return r.create=function(e,t){return new r(n.generateRandomId(8),e,t)},r.fromJson=function(t){if(!e.isObject(t))throw new Error("Invalid argument.");return new r(t.id,t.flags,t.payload)},r.prototype={toJson:function(){return{id:this.id,flags:this.flags,payload:this.payload}}},r}),n("Connection",["lodash","Request","Response","Packet","Utils"],function(e,t,n,r,i){var s=function(e,t,n){var s=this;i.isZeroOrPositiveNumber(n.connectionCloseDelay)||(n.connectionCloseDelay=3e4),this._conn=e,this._callbacks=t,this._config=n,this._shutdown=!1,this._conn.on("data",function(e){var n;try{n=r.fromJson(e)}catch(i){console.error(i);return}if(n.flags.FIN){s._shutdown=!0,t.receivedFin(s);return}s._onDataReceived(n.payload)}),this._conn.on("close",function(){s._shutdown=!0,t.closedByRemote(s)}),this._conn.on("error",function(e){console.log(e)})};return s.prototype={send:function(e,t){var n=r.create({},e.toJson());if(!this.isAvailable())throw new Error("Connection is not available.");this._conn.send(n.toJson())},_onDataReceived:function(e){var r=this;if(n.isResponse(e)){var i;try{i=n.fromJson(e)}catch(s){console.log(s);return}this._callbacks.responseReceived(this,i)}else if(t.isRequest(e)){var o;try{o=t.fromJson(e)}catch(s){console.log(s);return}this._callbacks.requestReceived(this,o)}},close:function(){this._callbacks.closedByLocal(this)},shutdown:function(){var t=this;if(this.isAvailable()){var n=r.create({FIN:!0},{});this._conn.send(n.toJson())}this._shutdown=!0,e.delay(function(){t._conn.close()},this._config.connectionCloseDelay)},getPeerId:function(){return this._conn.peer},isAvailable:function(){return!this._shutdown&&this._conn.open}},s}),n("ConnectionFactory",["lodash","PeerAgent","Connection","Utils"],function(e,t,n,r){var i=function(i,s,o){var u=this,a={requestReceived:function(e,t){e.isAvailable()?u._connectionPool.set(e.getPeerId(),e):e.shutdown(),s.onRequestReceived(e.getPeerId(),t)},responseReceived:function(e,t){e.isAvailable()?u._connectionPool.set(e.getPeerId(),e):e.shutdown(),s.onResponseReceived(e.getPeerId(),t)},closedByRemote:function(e){u.removeConnection(e.getPeerId())},closedByLocal:function(e){e.isAvailable()?u._connectionPool.set(e.getPeerId(),e):e.shutdown()},receivedFin:function(e){a.closedByRemote(e)}};this._peerAgent=new t(i,{onPeerSetup:function(e,t){if(t){o(null,t);return}o(u)},onConnectionOpened:function(e,t,r){if(r){u._invokeNextCallback(e,null,r);return}var s=new n(t,a,i);u._invokeNextCallback(e,s)},onConnection:function(t,r){u._connectionPool.has(t)&&u.removeConnection(t);var s,o=setTimeout(function(){s.shutdown()},i.silentConnectionCloseTimeout),f=e.once(function(){clearTimeout(o)});s=new n(r,e.defaults({requestReceived:function(e,t){f(),a.requestReceived(e,t)},responseReceived:function(e,t){f(),a.responseReceived(e,t)}},a),i)},onPeerClosed:function(){e.each(u._connectionPool.keys(),function(e){u.removeConnection(e)})}}),r.isZeroOrPositiveNumber(i.connectionPoolSize)||(i.connectionPoolSize=10),r.isZeroOrPositiveNumber(i.silentConnectionCloseTimeout)||(i.silentConnectionCloseTimeout=3e4),this._connectionPool=new r.Cache(i.connectionPoolSize,function(e){e.shutdown()}),this._callbackQueue=new r.Queue};return i.create=function(e,t,n){var r=new i(e,t,n)},i.prototype={create:function(e,t){var n=this;if(!r.isNonemptyString(e)){t(null);return}this._callbackQueue.enqueue({peerId:e,callback:t}),this._createConnectionAndInvokeNextCallback()},_createConnectionAndInvokeNextCallback:function(){var t=this,n=this._callbackQueue.first();if(e.isNull(n))return;if(this._peerAgent.isWaitingForOpeningConnection())return;if(this._connectionPool.has(n.peerId)){var r=this._connectionPool.get(n.peerId);if(r.isAvailable()){this._invokeNextCallback(r.getPeerId(),r);return}this.removeConnection(r.getPeerId())}this._peerAgent.connect(n.peerId)},_invokeNextCallback:function(t,n,r){var i=this;e.defer(function(){i._createConnectionAndInvokeNextCallback()});var s=this._callbackQueue.dequeue();if(e.isNull(s)){console.log("Unknown situation.");return}if(s.peerId!==t){s.callback(null,new Error("Unknown situation."));return}s.callback(n,r)},removeConnection:function(t){var n=this._connectionPool.get(t);if(e.isNull(n))return;this._connectionPool.remove(t),n.shutdown()},destroy:function(){this._peerAgent.destroy()},getPeerId:function(){return this._peerAgent.getPeerId()},listAllPeers:function(e){this._peerAgent.listAllPeers(e)}},i}),n("RequestHandler",["lodash","ID","Response","Entry","Utils"],function(e,t,n,r,i){var s=function(e,t){this._localNode=e,this._nodeFactory=t};return s.prototype={handle:function(n,s,o){var u=this;switch(s.method){case"FIND_SUCCESSOR":if(!i.isNonemptyString(s.params.key)){this._sendFailureResponse("Invalid params.",s,o);return}var a=t.fromHexString(s.params.key);this._localNode.findSuccessorIterative(a,function(e,t,n){if(n){console.log(n),u._sendFailureResponse(h.message,s,o);return}e==="SUCCESS"?u._sendSuccessResponse({successorNodeInfo:t.toNodeInfo()},s,o):e==="REDIRECT"&&u._sendRedirectResponse({redirectNodeInfo:t.toNodeInfo()},s,o)});break;case"NOTIFY_AND_COPY":var f=s.params.potentialPredecessorNodeInfo;this._nodeFactory.create(f,function(t,n){if(n){console.log(n),this._sendFailureResponse(h.message,s,o);return}u._localNode.notifyAndCopyEntries(t,function(t,n){if(e.isNull(t)||e.isNull(n)){u._sendFailureResponse("Unknown error.",s,o);return}u._sendSuccessResponse({referencesNodeInfo:e.invoke(t,"toNodeInfo"),entries:e.invoke(n,"toJson")},s,o)})});break;case"NOTIFY":var f=s.params.potentialPredecessorNodeInfo;this._nodeFactory.create(f,function(t,n){if(n){console.log(n),u._sendFailureResponse(h.message,s,o);return}u._localNode.notify(t,function(t){if(e.isNull(t)){u._sendFailureResponse("Unknown error.",s,o);return}u._sendSuccessResponse({referencesNodeInfo:e.invoke(t,"toNodeInfo")},s,o)})});break;case"PING":u._sendSuccessResponse({},s,o);break;case"INSERT_REPLICAS":if(!e.isArray(s.params.replicas))return;var l=e.chain(s.params.replicas).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();u._localNode.insertReplicas(l);break;case"REMOVE_REPLICAS":var c;try{c=t.fromHexString(s.params.sendingNodeId)}catch(h){return}if(!e.isArray(s.params.replicas))return;var l=e.chain(s.params.replicas).map(function(e){try{return r.fromJson(e)}catch(t){return null}}).reject(function(t){return e.isNull(t)}).value();u._localNode.removeReplicas(c,l);break;case"INSERT_ENTRY":var p;try{p=r.fromJson(s.params.entry)}catch(h){u._sendFailureResponse(h.message,s,o);return}u._localNode.insertEntryIterative(p,function(e,t,n){if(n){console.log("Failed to insert entry:",n),u._sendFailureResponse("Unknown error.",s,o);return}e==="SUCCESS"?u._sendSuccessResponse({},s,o):e==="REDIRECT"&&u._sendRedirectResponse({redirectNodeInfo:t.toNodeInfo()},s,o)});break;case"RETRIEVE_ENTRIES":var d;try{d=t.fromHexString(s.params.id)}catch(h){u._sendFailureResponse(h.message,s,o);return}u._localNode.retrieveEntriesIterative(d,function(t,n,r,i){if(i){console.log("Failed to retrieve entries:",i),u._sendFailureResponse("Unknown error.",s,o);return}t==="SUCCESS"?u._sendSuccessResponse({entries:e.invoke(n,"toJson")},s,o):t==="REDIRECT"&&u._sendRedirectResponse({redirectNodeInfo:r.toNodeInfo()},s,o)});break;case"REMOVE_ENTRY":var p;try{p=r.fromJson(s.params.entry)}catch(h){u._sendFailureResponse(h.message,s,o);return}u._localNode.removeEntryIterative(p,function(e,t,n){if(n){console.log("Failed to remove entry:",n),u._sendFailureResponse("Unknown error.",s,o);return}e==="SUCCESS"?u._sendSuccessResponse({},s,o):e==="REDIRECT"&&u._sendRedirectResponse({redirectNodeInfo:t.toNodeInfo()},s,o)});break;case"UPPER_LAYER_MESSAGE":if(!e.has(s.params,"message"))return;u._localNode.onMessageReceived(n,s.params.message);break;case"SHUTDOWN":break;case"LEAVES_NETWORK":var v=s.params.predecessorNodeInfo;this._nodeFactory.create(v,function(e,t){if(t){console.log(t);return}u._localNode.leavesNetwork(e)});break;default:this._sendFailureResponse("Unknown request method type.",s,o)}},_sendSuccessResponse:function(e,t,n){this._sendResponse("SUCCESS",e,t,n)},_sendRedirectResponse:function(e,t,n){this._sendResponse("REDIRECT",e,t,n)},_sendResponse:function(e,t,r,i){var s=this,o;try{o=n.create(e,t,r)}catch(u){this._sendFailureResponse(u.message,r,i);return}i(o)},_sendFailureResponse:function(e,t,r){var i;try{i=n.create("FAILED",{message:e},t)}catch(s){return}r(i)}},s}),n("NodeFactory",["lodash","Node","ConnectionFactory","RequestHandler","ID","Utils"],function(e,t,n,r,i,s){var o=function(t,n){var i=this;if(e.isNull(t))throw new Error("Invalid arguments.");this._localNode=t,this._config=n,this._connectionFactory=null,this._requestHandler=new r(t,this),this._callbacks={}};return o.create=function(t,r,i){e.isNull(t)&&i(null,null);var s=new o(t,r);n.create(r,s,function(e,t){if(t){i(null,null,t);return}s._connectionFactory=e,i(e.getPeerId(),s)})},o.prototype={create:function(e,n){var r=this;if(!t.isValidNodeInfo(e)){n(null,new Error("Invalid node info."));return}if(this._localNode.nodeId.equals(i.create(e.peerId))){n(this._localNode);return}var s=new t(e,this,this._connectionFactory,this._requestHandler,this._config);n(s)},createAll:function(t,n){var r=this;if(e.isEmpty(t)){n([]);return}this.create(e.first(t),function(i,s){r.createAll(e.rest(t),function(e){s?(console.log(s),n(e)):n([i].concat(e))})})},onRequestReceived:function(e,t){this.create({peerId:e},function(e,n){if(n){console.log(n);return}e.onRequestReceived(t)})},onResponseReceived:function(e,t){this.create({peerId:e},function(e,n){if(n){console.log(n);return}e.onResponseReceived(t)})},registerCallback:function(e,t){this._callbacks[e]=t},deregisterCallback:function(t){if(!e.has(this._callbacks,t))return null;var n=this._callbacks[t];return delete this._callbacks[t],n},destroy:function(){this._connectionFactory.destroy()},listAllPeers:function(e){this._connectionFactory.listAllPeers(e)}},o}),n("EntryList",["lodash","ID","Utils"],function(e,t,n){var r=function(){this._entries={}};return r.prototype={addAll:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");e.each(t,function(e){n.add(e)})},add:function(t){if(e.isNull(t))throw new Error("Invalid argument.");e.has(this._entries,t.id.toHexString())?this._entries[t.id.toHexString()].put(t):this._entries[t.id.toHexString()]=new n.Set([t],function(e,t){return e.equals(t)}),n.debug("An entry added (key:",t.id.toHexString(),")")},remove:function(t){if(e.isNull(t))throw new Error("Invalid argument.");if(!e.has(this._entries,t.id.toHexString()))return;this._entries[t.id.toHexString()].remove(t),this._entries[t.id.toHexString()].size()===0&&delete this._entries[t.id.toHexString()],n.debug("An entry removed (key:",t.id.toHexString(),")")},getEntries:function(t){if(e.isNull(t))throw new Error("Invalid argument.");return e.isUndefined(t)?this._entries:e.has(this._entries,t.toHexString())?this._entries[t.toHexString()].items():[]},getEntriesInInterval:function(n,r){if(e.isNull(n)||e.isNull(r))throw new Error("Invalid argument.");var i=[];return e.each(this._entries,function(e,s){t.fromHexString(s).isInInterval(n,r)&&(i=i.concat(e.items()))}),i=i.concat(this.getEntries(r)),i},removeAll:function(t){var n=this;if(e.isNull(t))throw new Error("Invalid argument.");e.each(t,function(e){n.remove(e)})},has:function(t){return e.has(this._entries,t.toHexString())},getNumberOfStoredEntries:function(){return e.size(this._entries)},getStatus:function(){return e.chain(this._entries).map(function(t,n){return[n,e.map(t,function(e){return e.value})]}).object().value()},dump:function(){return e.chain(this._entries).map(function(t){return e.invoke(t.items(),"toJson")}).flatten().value()},toString:function(){var n=this;return"[Entries]\n"+e.chain(this._entries).keys().map(function(e){return t.fromHexString(e)}).sort(function(e,t){return e.compareTo(t)}).map(function(t){return"["+t.toHexString()+"]\n"+e.map(n.getEntries(t),function(e){return JSON.stringify(e.value)}).join("\n")+"\n"}).value().join("\n")+"\n"}},r}),n("FingerTable",["lodash"],function(e){var t=function(t,n){if(!t||!n)throw new Error("Invalid arguments.");this._localId=t,this._references=n,this._table=e(this._localId.getLength()).times(function(){return null}).value(),this._powerOfTwos=e(this._localId.getLength()).times(function(e){return t.addPowerOfTwo(e)}).value()};return t.prototype={addReference:function(e){if(!e)throw new Error("Invalid argument.");if(e.nodeId.equals(this._localId))return;var t=e.nodeId.getIntervalInPowerOfTwoFrom(this._localId);for(var n=t+1;n<this._table.length;n++)if(!this._table[n])this._table[n]=e;else{if(!e.nodeId.isInInterval(this._table[n].nodeId,this._powerOfTwos[n]))break;var r=this._table[n];this._table[n]=e,this._references.disconnectIfUnreferenced(r)}},getClosestPrecedingNode:function(e){if(!e)throw new Error("Invalid argument.");if(e.equals(this._localId))return null;var t=e.getIntervalInPowerOfTwoFrom(this._localId);return this._table[t]},removeReference:function(e){var t=this;if(!e)throw new Error("Invalid argument.");if(e.nodeId.equals(this._localId))return;var n=e.nodeId.getIntervalInPowerOfTwoFrom(this._localId),r=this._table[n];for(var i=n+1;i<this._table.length;i++){if(!e.equals(this._table[i]))break;this._table[i]=r}this._references.disconnectIfUnreferenced(e)},getFirstFingerTableEntries:function(t){var n=[];for(var r=0;r<this._table.length;r++){this._table[r]&&(n.length===0||!e.last(n).equals(this._table[r]))&&n.push(this._table[r]);if(n.length>=t)break}return n},containsReference:function(e){if(!e)throw new Error("Invalid argument.");
if(e.nodeId.equals(this._localId))return!1;var t=e.nodeId.getIntervalInPowerOfTwoFrom(this._localId);return t===this._table.length-1?!1:e.equals(this._table[t+1])},getStatus:function(){var t=this;return e.map(this._table,function(e){return e?e.toNodeInfo():null})},toString:function(){var t=this;return"[FingerTable]\n"+e.chain(this._table).map(function(e,n){if(!e)return"";if(n===0||n>0&&!e.equals(t._table[n-1]))return"["+n+"] "+e.toString();if(n===t._table.length-1||!e.equals(t._table[n+1]))return"["+n+"]";if(n>1&&e.equals(t._table[n-1])&&!e.equals(t._table[n-2])||n===1&&e.equals(t._table[n-1]))return"...";if(n>1&&e.equals(t._table[n-1])&&e.equals(t._table[n-2]))return"";throw new Error("Unknown situation.")}).reject(function(e){return e===""}).value().join("\n")+"\n"}},t}),n("SuccessorList",["lodash","Utils"],function(e,t){var n=function(e,n,r,i){if(!e||!n||!r)throw new Error("Invalid argument.");t.isPositiveNumber(i.numberOfEntriesInSuccessorList)||(i.numberOfEntriesInSuccessorList=3),this._localId=e,this._capacity=i.numberOfEntriesInSuccessorList,this._entries=n,this._references=r,this._successors=[]};return n.prototype={addSuccessor:function(n){if(!n)throw new Error("Invalid argument.");if(this.containsReference(n))return;if(this._successors.length>=this._capacity&&n.nodeId.isInInterval(e.last(this._successors).nodeId,this._localId))return;var r=!1;for(var i=0;i<this._successors.length;i++)if(n.nodeId.isInInterval(this._localId,this._successors[i].nodeId)){t.insert(this._successors,i,n),r=!0;break}r||(this._successors.push(n),r=!0);var s,o=this._references.getPredecessor();if(o)s=o.nodeId;else{var u=this._references.getClosestPrecedingNode(this._localId);u?s=u.nodeId:s=this._localId}var a=this._localId,f=this._entries.getEntriesInInterval(s,a);n.insertReplicas(f);if(this._successors.length>this._capacity){var l=this._successors.pop();l.removeReplicas(this._localId,[]),this._references.disconnectIfUnreferenced(l)}},getDirectSuccessor:function(){return this._successors.length===0?null:this._successors[0]},getClosestPrecedingNode:function(e){if(!e)throw new Error("Invalid argument.");for(var t=this._successors.length-1;t>=0;t--)if(this._successors[t].nodeId.isInInterval(this._localId,e))return this._successors[t];return null},getReferences:function(){return e.clone(this._successors)},removeReference:function(t){var n=this;if(!t)throw new Error("Invalid argument.");this._successors=e.reject(this._successors,function(e){return e.equals(t)});var r=this._references.getFirstFingerTableEntries(this._capacity);r=e.reject(r,function(e){return e.equals(t)}),e.each(r,function(e){n.addSuccessor(e)})},getSize:function(){return this._successors.length},getCapacity:function(){return this._capacity},containsReference:function(t){if(!t)throw new Error("Invalid argument.");return e.some(this._successors,function(e){return e.equals(t)})},getStatus:function(){return e.invoke(this._successors,"toNodeInfo")},toString:function(){return"[Successors]\n"+e.map(this._successors,function(e,t){return"["+t+"] "+e.toString()}).join("\n")+"\n"}},n}),n("ReferenceList",["lodash","FingerTable","SuccessorList"],function(e,t,n){var r=function(e,r,i){if(!e||!r)throw new Error("Invalid arguments.");this._localId=e,this._fingerTable=new t(e,this),this._successors=new n(e,r,this,i),this._predecessor=null,this._entries=r};return r.prototype={addReference:function(e){if(!e)throw new Error("Invalid argument.");if(e.nodeId.equals(this._localId))return;this._fingerTable.addReference(e),this._successors.addSuccessor(e)},removeReference:function(e){if(!e)throw new Error("Invalid argument.");this._fingerTable.removeReference(e),this._successors.removeReference(e),e.equals(this.getPredecessor())&&(this._predecessor=null),this.disconnectIfUnreferenced(e)},getSuccessor:function(){return this._successors.getDirectSuccessor()},getSuccessors:function(){return this._successors.getReferences()},getClosestPrecedingNode:function(t){if(!t)throw new Error("Invalid argument.");if(t.equals(this._localId))return null;var n=[],r=this._fingerTable.getClosestPrecedingNode(t);r&&n.push(r);var i=this._successors.getClosestPrecedingNode(t);return i&&n.push(i),this._predecessor&&t.isInInterval(this._predecessor.nodeId,this._localId)&&n.push(this._predecessor),n.length===0?null:e.chain(n).sort(function(e,n){return t.sub(e.nodeId).compareTo(t.sub(n.nodeId))}).first().value()},getPredecessor:function(){return this._predecessor},addReferenceAsPredecessor:function(e){if(!e)throw new Error("Invalid argument.");if(e.nodeId.equals(this._localId))return;(!this._predecessor||e.nodeId.isInInterval(this._predecessor.nodeId,this._localId))&&this._setPredecessor(e),this.addReference(e)},_setPredecessor:function(t){if(!t)throw new Error("Invalid argument.");if(t.nodeId.equals(this._localId))return;if(t.equals(this._predecessor))return;var n=this._predecessor;this._predecessor=t;if(n){this.disconnectIfUnreferenced(n);var r=this._successors.getSize();if(this._successors.getCapacity()===r){var i=e.last(this._successors.getReferences());i.removeReplicas(this._predecessor.nodeId,[])}}else{var s=this._entries.getEntriesInInterval(this._predecessor.nodeId,this._localId),o=this._successors.getReferences();e.each(o,function(e){e.insertReplicas(s)})}},disconnectIfUnreferenced:function(e){if(!e)throw new Error("Invalid argument.");this.containsReference(e)||e.disconnect()},getFirstFingerTableEntries:function(e){return this._fingerTable.getFirstFingerTableEntries(e)},containsReference:function(e){if(!e)throw new Error("Invalid argurment.");return this._fingerTable.containsReference(e)||this._successors.containsReference(e)||e.equals(this._predecessor)},getStatuses:function(){return{successors:this._successors.getStatus(),fingerTable:this._fingerTable.getStatus(),predecessor:this.getPredecessor()?this.getPredecessor().toNodeInfo():null}},toString:function(){return[this._successors.toString(),"[Predecessor]\n"+(this.getPredecessor()?this.getPredecessor().toString():"")+"\n",this._fingerTable.toString()].join("\n")+"\n"}},r}),n("StabilizeTask",["lodash","Utils"],function(e,t){var n=function(e,t,n){this._localNode=e,this._references=t,this._entries=n,this._timer=null};return n.create=function(e,r,i,s){t.isZeroOrPositiveNumber(s.stabilizeTaskInterval)||(s.stabilizeTaskInterval=3e4);var o=new n(e,r,i),u=setInterval(function(){o.run()},s.stabilizeTaskInterval);return o._timer=u,o},n.prototype={run:function(){var n=this,r=this._references.getSuccessors();if(e.isEmpty(r))return;var i=e.first(r);i.notify(this._localNode,function(s,o){if(o){console.log(o),n._references.removeReference(i);return}var u=function(t){e.chain(r).reject(function(r){return r.equals(i)||!e.isNull(n._references.getPredecessor())&&r.equals(n._references.getPredecessor())||e.some(t,function(e){return e.equals(r)})}).each(function(e){n._references.removeReference(e)}),e.each(t,function(e){n._references.addReference(e)});var s=n._references.getSuccessor();s.equals(i)||s.ping(function(e){e&&(console.log(e),n._references.removeReference(s))})};e.size(s)>0&&!e.isNull(s[0])&&(n._localNode.equals(s[0])||i.notifyAndCopyEntries(n._localNode,function(r,i,s){if(s){console.log(s);return}n._entries.addAll(i),u(r),t.debug("[StabilizeTask] successors:",e.map(n._references.getSuccessors(),function(e){return e.getPeerId()}).toString())})),u(s),t.debug("[StabilizeTask] successors:",e.map(n._references.getSuccessors(),function(e){return e.getPeerId()}).toString())})},shutdown:function(){e.isNull(this._timer)||clearInterval(this._timer)}},n}),n("FixFingerTask",["lodash","Utils"],function(e,t){var n=function(e,t){this._localNode=e,this._references=t,this._timer=null};return n.create=function(e,r,i){t.isZeroOrPositiveNumber(i.fixFingerTaskInterval)||(i.fixFingerTaskInterval=3e4);var s=new n(e,r),o=setInterval(function(){s.run()},i.fixFingerTaskInterval);return s._timer=o,s},n.prototype={run:function(){var n=this,r=e.random(this._localNode.nodeId.getLength()-1),i=this._localNode.nodeId.addPowerOfTwo(r);this._localNode.findSuccessor(i,function(i,s){if(s){console.log(s);return}!e.isNull(i)&&!n._references.containsReference(i)&&n._references.addReference(i),t.debug("[FixFingerTask] finger:",r,", successor:",i.getPeerId())})},shutdown:function(){e.isNull(this._timer)||clearInterval(this._timer)}},n}),n("CheckPredecessorTask",["lodash","Utils"],function(e,t){var n=function(e){this._references=e,this._timer=null};return n.create=function(e,r){t.isZeroOrPositiveNumber(r.checkPredecessorTaskInterval)||(r.checkPredecessorTaskInterval=3e4);var i=new n(e),s=setInterval(function(){i.run()},r.checkPredecessorTaskInterval);return i._timer=s,i},n.prototype={run:function(){var n=this,r=this._references.getPredecessor();if(e.isNull(r))return;r.ping(function(e){if(e){console.log(e),n._references.removeReference(r);return}r=n._references.getPredecessor(),t.debug("[CheckPredecessorTask] predecessor:",r?r.getPeerId():null)})},shutdown:function(){e.isNull(this._timer)||clearInterval(this._timer)}},n}),n("LocalNode",["lodash","NodeFactory","EntryList","Entry","ReferenceList","ID","StabilizeTask","FixFingerTask","CheckPredecessorTask","Utils"],function(e,t,n,r,i,s,o,u,a,f){var l=function(e,t){f.isPositiveNumber(t.maximumNumberOfAttemptsOfNotifyAndCopyOnJoin)||(t.maximumNumberOfAttemptsOfNotifyAndCopyOnJoin=5),this._chord=e,this._config=t,this.nodeId=null,this._peerId=null,this._nodeFactory=null,this._tasks={},this._entries=null,this._references=null};return l.create=function(e,n,r){var i=new l(e,n);t.create(i,n,function(e,t,n){if(n){r(null,n);return}i.setup(e,t),r(i)})},l.prototype={setup:function(e,t){this._peerId=e,this.nodeId=s.create(e),this._nodeFactory=t,this._entries=new n,this._references=new i(this.nodeId,this._entries,this._config)},_createTasks:function(){this._tasks={stabilizeTask:o.create(this,this._references,this._entries,this._config),fixFingerTask:u.create(this,this._references,this._config),checkPredecessorTask:a.create(this._references,this._config)},f.debug("Created tasks.")},_shutdownTasks:function(){e.invoke(this._tasks,"shutdown"),f.debug("Shutdown tasks.")},create:function(e){this._createTasks(),f.debug("Created network (peer ID:",this._peerId,")."),e(this._peerId)},join:function(t,n){var r=this;f.debug("Trying to join network."),this._nodeFactory.create({peerId:t},function(t,i){if(i){n(null,i);return}r._references.addReference(t),t.findSuccessor(r.nodeId.addPowerOfTwo(0),function(i,s){if(s){f.debug("[join] Failed to find successor:",s),r._references.removeReference(t),n(null,s);return}f.debug("[join] Found successor:",i.getPeerId()),r._references.addReference(i);var o=function(t,n,s){f.debug("[join] Trying to notify and copy entries (remote peer ID:",t.getPeerId(),", attempts:",n,").");if(n===0){console.log("Reached maximum number of attempts of NOTIFY_AND_COPY."),s([],[]);return}t.notifyAndCopyEntries(r,function(u,a,l){if(l){f.debug("[join] Failed to notify and copy entries (remote peer ID:",t.getPeerId(),")."),s(null,null,l);return}if(e.size(u)===1){f.debug("[join]",i.getPeerId(),"is successor and also predecessor."),r._references.addReferenceAsPredecessor(i),s(u,a);return}if(u[0].equals(r)){f.debug("[join] Left predecessor as null."),s(u,a);return}if(r.nodeId.isInInterval(u[0].nodeId,i.nodeId)){f.debug("[join]",u[0].getPeerId(),"is predecessor."),r._references.addReferenceAsPredecessor(u[0]),s(u,a);return}f.debug("[join] Failed to find predecessor. Retry to notify and copy entries."),r._references.addReference(u[0]),o(u[0],n-1,s)})},u=r._config.maximumNumberOfAttemptsOfNotifyAndCopyOnJoin;o(i,u,function(t,i,s){if(s){console.log("Failed to notify and copy entries:",s),r._createTasks(),n(r._peerId);return}e.each(t,function(t){!e.isNull(t)&&!t.equals(r)&&!r._references.containsReference(t)&&r._references.addReference(t)}),r._entries.addAll(i),e.defer(function(){r._chord.onentriesinserted(e.invoke(i,"toJson"))}),r._createTasks(),f.debug("Joining network succeeded."),n(r._peerId)})})})},leave:function(t){var n=this;this._shutdownTasks();var r=this._references.getSuccessor();!e.isNull(r)&&!e.isNull(this._references.getPredecessor())&&r.leavesNetwork(this._references.getPredecessor()),this._nodeFactory.destroy(),f.debug("Left network."),t()},insert:function(e,t,n){var i;try{i=new r(s.create(e),t)}catch(o){n(null,o);return}this.findSuccessor(i.id,function(e,t){if(t){n(null,t);return}e.insertEntry(i,function(e){if(e){n(null,e);return}n(i.id.toHexString())})})},retrieve:function(t,n){var r;try{r=s.create(t)}catch(i){n(null,i);return}this.findSuccessor(r,function(t,i){if(i){n(null,i);return}t.retrieveEntries(r,function(t,r){if(r){n(null,r);return}n(e.map(t,function(e){return e.value}))})})},remove:function(e,t,n){var i;try{i=new r(s.create(e),t)}catch(o){n(o);return}this.findSuccessor(i.id,function(e,t){if(t){n(t);return}e.removeEntry(i,n)})},getEntries:function(){return this._entries.dump()},setEntries:function(t){this._entries.addAll(e.map(t,function(e){return r.fromJson(e)}))},findSuccessor:function(t,n){var r=this;if(e.isNull(t)){n(null,new Error("Invalid argument."));return}if(!this._references.getPredecessor()||t.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)||t.equals(this.nodeId)){n(this);return}var i=this._references.getClosestPrecedingNode(t);if(!i){var s=this._references.getSuccessor();if(!s){n(this);return}i=s}i.findSuccessor(t,function(e,s){if(s){console.log(s),r._references.removeReference(i),r.findSuccessor(t,n);return}n(e)})},findSuccessorIterative:function(t,n){var r=this;if(e.isNull(t)){n("FAILED",null,new Error("Invalid argument."));return}if(!this._references.getPredecessor()||t.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)||t.equals(this.nodeId)){n("SUCCESS",this);return}var i=this._references.getClosestPrecedingNode(t);if(!i){var s=this._references.getSuccessor();if(!s){n("SUCCESS",this);return}i=s}n("REDIRECT",i)},notifyAndCopyEntries:function(e,t){var n=this,r=this.notify(e,function(r){var i=n._entries.getEntriesInInterval(n.nodeId,e.nodeId);t(r,i)})},notify:function(t,n){var r=[];e.isNull(this._references.getPredecessor())?r.push(t):r.push(this._references.getPredecessor()),r=r.concat(this._references.getSuccessors()),this._references.addReferenceAsPredecessor(t),n(r)},leavesNetwork:function(e){this._references.removeReference(this._references.getPredecessor()),this._references.addReferenceAsPredecessor(e)},insertReplicas:function(t){var n=this;this._entries.addAll(t),e.defer(function(){n._chord.onentriesinserted(e.invoke(t,"toJson"))})},removeReplicas:function(t,n){var r=this;if(e.size(n)!==0){this._entries.removeAll(n),e.defer(function(){r._chord.onentriesremoved(e.invoke(n,"toJson"))});return}var i=this._entries.getEntriesInInterval(this.nodeId,t);this._entries.removeAll(i),e.defer(function(){r._chord.onentriesremoved(e.invoke(i,"toJson"))})},insertEntry:function(e,t){this.insertEntryIterative(e,function(n,r){n==="SUCCESS"?t():n==="REDIRECT"?r.insertEntry(e,t):t(new Error("Got unknown status:",n))})},insertEntryIterative:function(t,n){var r=this;if(this._references.getPredecessor()&&!t.id.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)&&!t.id.equals(this.nodeId)){n("REDIRECT",this._references.getPredecessor());return}this._entries.add(t),e.defer(function(){r._chord.onentriesinserted([t.toJson()])}),e.each(this._references.getSuccessors(),function(e){e.insertReplicas([t])}),n("SUCCESS")},retrieveEntries:function(e,t){this.retrieveEntriesIterative(e,function(n,r,i){n==="SUCCESS"?t(r):n==="REDIRECT"?i.retrieveEntries(e,t):t(null,new Error("Got unknown status:",n))})},retrieveEntriesIterative:function(e,t){if(this._entries.has(e)){t("SUCCESS",this._entries.getEntries(e));return}if(this._references.getPredecessor()&&!e.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)&&!e.equals(this.nodeId)){t("REDIRECT",null,this._references.getPredecessor());return}t("SUCCESS",this._entries.getEntries(e))},removeEntry:function(e,t){this.removeEntryIterative(e,function(n,r){n==="SUCCESS"?t():n==="REDIRECT"?r.removeEntry(e,t):t(new Error("Got unknown status:",n))})},removeEntryIterative:function(t,n){var r=this;if(this._references.getPredecessor()&&!t.id.isInInterval(this._references.getPredecessor().nodeId,this.nodeId)&&!t.id.equals(this.nodeId)){n("REDIRECT",this._references.getPredecessor());return}this._entries.remove(t),e.defer(function(){r._chord.onentriesremoved([t.toJson()])}),e.each(this._references.getSuccessors(),function(e){e.removeReplicas(r.nodeId,[t])}),n("SUCCESS")},sendMessage:function(t,n){if(e.isNull(t)){e.isNull(this._references.getSuccessor())||this._references.getSuccessor().sendMessage(n);return}this._nodeFactory.create({peerId:t},function(e){e.sendMessage(n)})},onMessageReceived:function(e,t){this._chord.onMessageReceived(e,t)},listAllPeers:function(e){this._nodeFactory.listAllPeers(e)},getStatuses:function(){var e=this._references.getStatuses();return e.entries=this._entries.getStatus(),e},getPeerId:function(){return this._peerId},toNodeInfo:function(){return{nodeId:this.nodeId.toHexString(),peerId:this._peerId}},equals:function(t){return e.isNull(t)?!1:this.nodeId.equals(t.nodeId)},toString:function(){return this.nodeId.toHexString()+" ("+this._peerId+")"},toDisplayString:function(){return[this._references.toString(),this._entries.toString()].join("\n")+"\n"}},l}),n("Chord",["lodash","LocalNode","Utils"],function(e,t,n){var r=function(t,r){if(!e.isObject(t))throw new Error("Invalid argument.");n.enableDebugLog(t.debug),this.version=n.version.join("."),this._config=t,this._localNode=null,this.onentriesinserted=function(e){},this.onentriesremoved=function(e){},this._onMessageReceivedCallback=r};return r.prototype={create:function(e){var n=this;if(this._localNode)throw new Error("Local node is already created.");e||(e=function(){}),t.create(this,this._config,function(t,r){if(r){e(null,r);return}n._localNode=t,n._localNode.create(function(t,r){r&&(n.leave(),n._localNode=null),e(t,r)})})},join:function(e,r){var i=this;if(!n.isNonemptyString(e))throw new Error("Invalid argument.");if(this._localNode)throw new Error("Local node is already created.");r||(r=function(){}),t.create(this,this._config,function(t,n){if(n){r(null,n);return}i._localNode=t,i._localNode.join(e,function(e,t){t&&(i.leave(),i._localNode=null),r(e,t)})})},leave:function(){var e=this;if(!this._localNode)return;this._localNode.leave(function(){e._localNode=null})},insert:function(t,r,i){i||(i=function(){});if(!this._localNode){i(null,new Error("Create or join network at first."));return}if(!n.isNonemptyString(t)||e.isUndefined(r)){i(null,new Error("Invalid arguments."));return}this._localNode.insert(t,r,i)},retrieve:function(e,t){t||(t=function(){});if(!this._localNode){t(null,new Error("Create or join network at first."));return}if(!n.isNonemptyString(e)){t(null,new Error("Invalid argument."));return}this._localNode.retrieve(e,t)},remove:function(t,r,i){i||(i=function(){});if(!this._localNode){i(new Error("Create or join network at first."));return}if(!n.isNonemptyString(t)||e.isUndefined(r)){i(new Error("Invalid arguments."));return}this._localNode.remove(t,r,i)},sendMessage:function(e,t){if(!this._localNode)throw new Error("Create or join network at first.");this._localNode.sendMessage(e,t)},onMessageReceived:function(e,t){this._onMessageReceivedCallback(e,t)},listAllPeers:function(e){if(!this._localNode){e(null,new Error("Create or join network at first."));return}this._localNode.listAllPeers(e)},getEntries:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.getEntries()},setEntries:function(e){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.setEntries(e)},getStatuses:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.getStatuses()},getPeerId:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.getPeerId()},getNodeId:function(){if(!this._localNode)throw new Error("Create or join network at first.");return this._localNode.nodeId.toHexString()},toString:function(){return this._localNode?this._localNode.toDisplayString():""}},r}),t("Chord")});browserify_shim__define__module__export__(typeof Chord!="undefined"?Chord:window.Chord)}).call(global,undefined,undefined,undefined,undefined,function defineExport(ex){module.exports=ex})}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],2:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var ApplicationController=_dereq_("./ApplicationController");var ApplicationView=_dereq_("../views/ApplicationView");var IndexView=_dereq_("../views/about/IndexView");var Utils=_dereq_("../utils/Utils");var AboutController=Utils.inherit(ApplicationController,function(networkAgent){ApplicationController.call(this,networkAgent)});AboutController.prototype.index=function(args,format){var requiredFunctions=Utils.listRequiredFunctions();this._response(format,{html:function(){(new ApplicationView).render(new IndexView,requiredFunctions,Utils.version)}})};module.exports=AboutController})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"../views/ApplicationView":25,"../views/about/IndexView":26,"./ApplicationController":3}],3:[function(_dereq_,module,exports){(function(){var ApplicationController=function(networkAgent){this._networkAgent=networkAgent};ApplicationController.prototype={_response:function(format,callbacks){if(!callbacks){return}switch(format){case"html":if(callbacks.html){callbacks.html()}break;case"json":if(callbacks.json){callbacks.json()}break}}};module.exports=ApplicationController})()},{}],4:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var ApplicationController=_dereq_("./ApplicationController");var ApplicationView=_dereq_("../views/ApplicationView");var IndexView=_dereq_("../views/contact/IndexView");var Utils=_dereq_("../utils/Utils");var ContactController=Utils.inherit(ApplicationController,function(networkAgent){ApplicationController.call(this,networkAgent)});ContactController.prototype.index=function(args,format){this._response(format,{html:function(){(new ApplicationView).render(new IndexView)}})};module.exports=ContactController})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"../views/ApplicationView":25,"../views/contact/IndexView":27,"./ApplicationController":3}],5:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var ApplicationController=_dereq_("./ApplicationController");var Thread=_dereq_("../models/Thread");var Message=_dereq_("../models/Message");var ApplicationView=_dereq_("../views/ApplicationView");var ShowView=_dereq_("../views/message/ShowView");var Utils=_dereq_("../utils/Utils");var MessageController=Utils.inherit(ApplicationController,function(networkAgent){ApplicationController.call(this,networkAgent)});MessageController.prototype.create=function(args,format){var self=this;if(!_.contains(this._networkAgent.getJoiningThreadIds(),args.threadId)){throw new Error("Unknown thread ID: "+args.threadId)}Message.new(args).exists(function(exists){Message.create(args,function(message,error){if(error){throw new Error("Failed to create message:",error)}Utils.debug("Created or updated message:",message.id);if(!exists){Utils.debug("Spreading message:",message.id);self._networkAgent.spreadMessage(message.toJson())}self._response(format,{html:function(){WebRtcBbs.context.routing.to("/thread/show",{threadId:args.threadId},true)}})})})};MessageController.prototype.show=function(args,format){var self=this;if(!args||!args.messageId){throw new Error("Message ID is required.")}Message.get(args.messageId,function(message,error){if(error){throw error}self._response(format,{html:function(){(new ApplicationView).render(new ShowView,message)}})})};MessageController.prototype.delete=function(args,format){var self=this;if(!args.messageId){throw new Error("Required message ID.")}Message.delete(args.messageId,function(error){if(error){throw error}self._response(format,{html:function(){if(args.threadId){WebRtcBbs.context.routing.to("/thread/show",{threadId:args.threadId})}else{WebRtcBbs.context.routing.to("/thread")}}})})};module.exports=MessageController})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../models/Message":12,"../models/Thread":14,"../utils/Utils":24,"../views/ApplicationView":25,"../views/message/ShowView":28,"./ApplicationController":3}],6:[function(_dereq_,module,exports){(function(){var ApplicationController=_dereq_("./ApplicationController");var ApplicationView=_dereq_("../views/ApplicationView");var IndexView=_dereq_("../views/settings/IndexView");var Setting=_dereq_("../models/Setting");var Thread=_dereq_("../models/Thread");var Utils=_dereq_("../utils/Utils");var SettingsController=Utils.inherit(ApplicationController,function(networkAgent){ApplicationController.call(this,networkAgent)});SettingsController.prototype.index=function(args,format){var self=this;var state=this._networkAgent.getState();var peerId=this._networkAgent.getPeerId();var directConnectedPeers=this._networkAgent.getDirectConnectedPeers();var peers=this._networkAgent.getPeers();Thread.all(function(threads){threads=_.filter(threads,function(thread){return _.contains(self._networkAgent.getJoiningThreadIds(),thread.id)});var threadsInfo=_.map(threads,function(thread){return{thread:thread,directConnectedPeers:self._networkAgent.getDirectConnectedPeers(thread.id)}});Setting.get(Setting.defaultId,function(setting,error){if(error){console.log("Failed to load settings:",error);setting=Setting.getDefaults()}self._response(format,{html:function(){(new ApplicationView).render(new IndexView,state,peerId,directConnectedPeers,peers,threadsInfo,setting)}})})})};SettingsController.prototype.update=function(args,format){Setting.create(args.setting,function(setting,error){if(error){console.log("Failed to save settings:",error)}WebRtcBbs.context.routing.to("/settings")})};module.exports=SettingsController})()},{"../models/Setting":13,"../models/Thread":14,"../utils/Utils":24,"../views/ApplicationView":25,"../views/settings/IndexView":29,"./ApplicationController":3}],7:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var ApplicationController=_dereq_("./ApplicationController");var ApplicationView=_dereq_("../views/ApplicationView");var IndexView=_dereq_("../views/thread/IndexView");var ShowView=_dereq_("../views/thread/ShowView");var Thread=_dereq_("../models/Thread");var Message=_dereq_("../models/Message");var Utils=_dereq_("../utils/Utils");var ThreadController=Utils.inherit(ApplicationController,function(networkAgent){ApplicationController.call(this,networkAgent)});ThreadController.prototype.index=function(args,format,callback){var self=this;if(format==="html"){_.defer(function(){WebRtcBbs.context.tasks.updateBbsContentsTask.run()})}var requiredFunctions=Utils.listRequiredFunctions();var alerts=_.chain(requiredFunctions).map(function(support,funcName){return support?"":funcName+" is not supported on your browser."}).compact().value();try{this._networkAgent.checkPeerSetting()}catch(e){alerts.push("The settings of this system is incomplete. "+"Please inform the administrator of the system about the following message: "+e.message)}Thread.all(function(threads,error){if(error){console.log("Failed to get threads:",error);threads=[]}if(args&&args.excludeIds){if(!_.isArray(args.excludeIds)){throw new Error("Invalid args.")}threads=_.reject(threads,function(thread){return _.contains(args.excludeIds,thread.id)})}self._response(format,{html:function(){(new ApplicationView).render(new IndexView,threads,alerts,function(params){try{Thread.new(params);return""}catch(e){return e.message}})},json:function(){callback(_.invoke(threads,"toJson"))}})})};ThreadController.prototype.create=function(args,format){var self=this;if(!args.name){throw new Error("Thread name is empty.")}Thread.new(args).exists(function(exists){Thread.create(args,function(thread,error){if(error){console.log("Failed to create thread:",error);return}Utils.debug("Created or updated thread:",thread.id);if(!exists){Utils.debug("Spreading thread:",thread.id);self._networkAgent.spreadThread(thread.toJson())}self._response(format,{html:function(){WebRtcBbs.context.routing.to("/thread/show",{threadId:thread.id})}})})})};ThreadController.prototype.show=function(args,format,callback){var self=this;if(!args||!args.threadId){throw new Error("Thread ID is required.")}if(format==="html"){this._networkAgent.joinThreadNetwork(args.threadId,function(peerId,error){if(error){console.log("Failed to join thread network (thread ID: "+args.threadId+"): "+error);return}Utils.debug("Joined thread network (thread ID:",args.threadId,"):",error);if(self._networkAgent.getState(args.threadId)==="connected"){_.defer(function(){WebRtcBbs.context.tasks.updateBbsContentsTask.run()})}})}Thread.get(args.threadId,function(thread,error){if(error){throw new Error("Failed to get thread:",error)}thread.getMessages(function(messages,error){if(error){throw new Error("Failed to get messages:",error)}if(args.excludeIds){if(!_.isArray(args.excludeIds)){throw new Error("Invalid args.")}messages=_.reject(messages,function(message){return _.contains(args.excludeIds,message.id)})}self._response(format,{html:function(){(new ApplicationView).render(new ShowView,thread,messages,args.fillInMessage,function(params){try{Message.new(params);return""}catch(e){return e.message}})},json:function(){callback(thread.toJson(),_.invoke(messages,"toJson"))}})})})};ThreadController.prototype.leave=function(args,format){if(format!=="html"){return}try{this._networkAgent.leaveThreadNetwork(args.threadId)}catch(e){console.log(e)}this._response(format,{html:function(){WebRtcBbs.context.routing.reload()}})};module.exports=ThreadController})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../models/Message":12,"../models/Thread":14,"../utils/Utils":24,"../views/ApplicationView":25,"../views/thread/IndexView":30,"../views/thread/ShowView":31,"./ApplicationController":3}],8:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var MemoryDb=_dereq_("./MemoryDb");var Utils=_dereq_("../utils/Utils");var DbManager=function(db){this._db=db};DbManager.initialize=function(callback){var DB_NAME="WebRtcBbs";var DB_VERSION=3;if(!callback){callback=function(){}}if(!window.indexedDB){DbManager._instance=new MemoryDb;callback(new Error("indexedDB is not supported."));return}var request=indexedDB.open(DB_NAME,DB_VERSION);request.onupgradeneeded=function(e){Utils.debug("Upgrade DB.");e.target.transaction.onerror=function(e){Utils.debug("Transaction failed:",e.value);callback(e.value)};var db=e.target.result;if(db.objectStoreNames.contains("thread")){db.deleteObjectStore("thread")}var threadStore=db.createObjectStore("thread",{keyPath:"id"});if(db.objectStoreNames.contains("message")){db.deleteObjectStore("message")}var messageStore=db.createObjectStore("message",{keyPath:"id"});messageStore.createIndex("threadIdIndex","threadId",{unique:false});messageStore.createIndex("dateIndex","date",{unique:false});if(db.objectStoreNames.contains("setting")){db.deleteObjectStore("setting")}var settingStore=db.createObjectStore("setting",{keyPath:"id"})};request.onsuccess=function(e){Utils.debug("Opening DB succeeded.");DbManager._instance=new DbManager(e.target.result);callback()};request.onerror=function(e){Utils.debug("Failed to open DB:",e.value);
DbManager._instance=new MemoryDb;callback(e.value)}};DbManager.getInstance=function(){return DbManager._instance};DbManager._instance=null;DbManager.prototype={all:function(store,callback){if(!callback){callback=function(){}}var records=[];var request=this._db.transaction(store,"readonly").objectStore(store).openCursor();request.onsuccess=function(e){var result=e.target.result;if(!result){callback(records);return}records.push(result.value);result.continue()};request.onerror=function(e){callback(null,e.value)}},get:function(store,id,callback){if(!callback){callback=function(){}}var request=this._db.transaction(store,"readonly").objectStore(store).get(id);request.onsuccess=function(e){var result=e.target.result;if(!result){callback(null,new Error("ID:",id,"is not found in",store,"store."));return}callback(result)};request.onerror=function(e){callback(null,e.value)}},"delete":function(store,id,callback){if(!callback){callback=function(){}}var request=this._db.transaction(store,"readwrite").objectStore(store).delete(id);request.onsuccess=function(e){callback()};request.onerror=function(e){callback(e.value)}},deleteAll:function(store,callback){if(!callback){callback=function(){}}var request=this._db.transaction(store,"readwrite").objectStore(store).clear();request.onsuccess=function(e){callback()};request.onerror=function(e){callback(e.value)}},save:function(store,record,callback){if(!callback){callback=function(){}}var request=this._db.transaction(store,"readwrite").objectStore(store).put(record);request.onsuccess=function(e){var result=e.target.result;if(!result){callback(null,new Error("Failed to save record:",record));return}callback(record)};request.onerror=function(e){callback(null,e.value)}},saveAll:function(store,records,callback){if(!callback){callback=function(){}}var self=this;if(records.length===0){callback([]);return}this.save(store,records[0],function(record,error){self.saveAll(store,records.slice(1),function(records){if(error){console.log(error);callback(records)}else{callback([record].concat(records))}})})},update:function(store,records,callback){if(!callback){callback=function(){}}var self=this;if(records.length===0){callback([]);return}this.get(store,records[0].id,function(record,error){if(error){console.log(error);self.update(store,records.slice(1),callback);return}self.save(store,_.extend(record,records[0]),function(record,error){self.update(store,records.slice(1),function(records){if(error){console.log(error);callback(records)}else{callback([record].concat(records))}})})})},where:function(store,cond,callback){if(!callback){callback=function(){}}this.all(store,function(records,error){if(error){callback(null,error);return}callback(_.filter(records,cond))})},find:function(store,query,callback){if(!callback){callback=function(){}}var records=[];var request=this._db.transaction(store,"readonly").objectStore(store).index(this._getIndexName(query)).openCursor(this._getKeyRange(query));request.onsuccess=function(e){var result=e.target.result;if(!result){callback(records);return}records.push(result.value);result.continue()};request.onerror=function(e){callback(null,e.value)}},_getIndexName:function(query){return _.keys(query)[0]+"Index"},_getKeyRange:function(query){var value=_.values(query)[0];if(_.isString(value)){return IDBKeyRange.only(value)}if(_.has(value,"upperBound")&&_.has(value,"lowerBound")){return IDBKeyRange.bound(value.lowerBound,value.upperBound,true,true)}if(_.has(value,"upperBound")&&!_.has(value,"lowerBound")){return IDBKeyRange.upperBound(value.upperBound,true)}if(!_.has(value,"upperBound")&&_.has(value,"lowerBound")){return IDBKeyRange.lowerBound(value.lowerBound,true)}}};module.exports=DbManager})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"./MemoryDb":9}],9:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Utils=_dereq_("../utils/Utils");var MemoryDb=function(){this._db={}};MemoryDb.prototype={all:function(store,callback){if(!callback){callback=function(){}}callback([])},get:function(store,id,callback){if(!callback){callback=function(){}}callback(null,new Error("Not implemented."))},"delete":function(store,id,callback){if(!callback){callback=function(){}}callback()},deleteAll:function(store,callback){if(!callback){callback=function(){}}callback()},save:function(store,record,callback){if(!callback){callback=function(){}}callback(null,new Error("Not implemented."))},saveAll:function(store,records,callback){if(!callback){callback=function(){}}callback([])},update:function(store,records,callback){if(!callback){callback=function(){}}callback([])},where:function(store,cond,callback){if(!callback){callback=function(){}}callback([])},find:function(store,query,callback){if(!callback){callback=function(){}}callback([])}};module.exports=MemoryDb})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24}],10:[function(_dereq_,module,exports){(function(global){(function(){var $=typeof window!=="undefined"?window.$:typeof global!=="undefined"?global.$:null;var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Routing=_dereq_("./routing/Routing");var NetworkAgent=_dereq_("./net/NetworkAgent");var Setting=_dereq_("./models/Setting");var DbManager=_dereq_("./db/DbManager");var UpdateBbsContentsTask=_dereq_("./tasks/UpdateBbsContentsTask");var MaintenanceNetworkTask=_dereq_("./tasks/MaintenanceNetworkTask");var Utils=_dereq_("./utils/Utils");var main=function(){var config={peer:{options:{host:window.location.hostname,port:Number(window.location.port)||80,key:"webrtc-bbs"}}};Utils.enableDebugLog(config.debug);$(function(){window.WebRtcBbs={context:{}};DbManager.initialize(function(error){if(error){console.log("Failed to initialize DB:",error)}Setting.exists(Setting.defaultId,function(exists){if(!exists){Utils.debug("Setting does not exist, create it.");Setting.create(Setting.getDefaults(),function(setting,error){if(error){console.log("Failed to create setting:",error)}})}});var networkAgent=new NetworkAgent(config);networkAgent.joinNetwork(function(peerId,error){if(error){console.log("Failed to join network: "+error);return}Utils.debug("Peer ID: "+peerId);WebRtcBbs.context.tasks.updateBbsContentsTask.run()});WebRtcBbs.context.routing=new Routing(networkAgent);WebRtcBbs.context.tasks={updateBbsContentsTask:UpdateBbsContentsTask.create(networkAgent,config),maintenanceNetworkTask:MaintenanceNetworkTask.create(networkAgent,config)};$(window).on("popstate",function(e){var state=e.originalEvent.state;WebRtcBbs.context.routing.to(state.path,state.args,true)});if(window.history){history.replaceState({path:"/",args:{}},null)}WebRtcBbs.context.routing.to("/")})})};module.exports={main:main}})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./db/DbManager":8,"./models/Setting":13,"./net/NetworkAgent":16,"./routing/Routing":20,"./tasks/MaintenanceNetworkTask":22,"./tasks/UpdateBbsContentsTask":23,"./utils/Utils":24}],11:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var DbManager=_dereq_("../db/DbManager");var BaseModel=function(){};BaseModel.all=function(model,store,callback){if(!callback){callback=function(){}}DbManager.getInstance().all(store,function(records,error){if(error){callback(null,error)}else{callback(_.map(records,function(record){return model.new(record)}))}})};BaseModel.get=function(model,store,id,callback){if(!callback){callback=function(){}}DbManager.getInstance().get(store,id,function(record,error){if(error){callback(null,error)}else{callback(model.new(record))}})};BaseModel.new=function(model,params){if(!_.isObject(params)){throw new Error("Invalid params.")}return new model(params)};BaseModel.create=function(model,params,callback){try{model.new(params).save(callback)}catch(e){if(callback){callback(null,e)}}};BaseModel.createAll=function(model,store,paramsList,callback){if(!callback){callback=function(){}}DbManager.getInstance().saveAll(store,_.map(paramsList,function(params){return model.new(params).toRecord()}),function(records){callback(_.map(records,function(record){return model.new(record)}))})};BaseModel.update=function(model,store,paramsList,callback){if(!callback){callback=function(){}}DbManager.getInstance().update(store,paramsList,function(records){callback(_.map(records,function(record){return model.new(record)}))})};BaseModel.delete=function(store,id,callback){DbManager.getInstance().delete(store,id,callback)};BaseModel.deleteAll=function(store,callback){DbManager.getInstance().deleteAll(store,callback)};BaseModel.exists=function(model,store,id,callback){if(!callback){callback=function(){}}BaseModel.get(model,store,id,function(instance,error){callback(!error)})};BaseModel.where=function(model,store,cond,callback){if(!callback){callback=function(){}}DbManager.getInstance().where(store,cond,function(records,error){if(error){callback(null,error)}else{callback(_.map(records,function(record){return model.new(record)}))}})};BaseModel.find=function(model,store,query,callback){if(!callback){callback=function(){}}DbManager.getInstance().find(store,query,function(records,error){if(error){calback(null,error)}else{callback(_.map(records,function(record){return model.new(record)}))}})};BaseModel.prototype={save:function(store,callback){if(!callback){callback=function(){}}var self=this;DbManager.getInstance().save(store,this.toRecord(),function(record,error){if(error){callback(null,error)}else{callback(self)}})},destroy:function(store,callback){DbManager.getInstance().delete(store,this.id,callback)},toJson:function(){throw new Error("Not implemented.")},toRecord:function(){throw new Error("Not implemented.")}};module.exports=BaseModel})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../db/DbManager":8}],12:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var BaseModel=_dereq_("./BaseModel");var Utils=_dereq_("../utils/Utils");var Message=Utils.inherit(BaseModel,function(params){BaseModel.call(this,params);if(!Utils.isNonemptyString(params.threadId)||!Utils.isNonemptyString(params.date)&&!_.isDate(params.date)){throw new Error("Invalid params.")}if(!Utils.isNonemptyString(params.body)){throw new Error("Message must not be empty.")}if(_.size(params.body)>Message.MAX_BODY_LENGTH){throw new Error("Message is too long. Max length is "+Message.MAX_BODY_LENGTH+".")}params.body=Utils.normalizeLineFeedCode(params.body);if(_.chain(params.body).filter(function(c){return c==="\n"}).size().value()>Message.MAX_BODY_LINE){console.log(params.id);throw new Error("Line length of message is too long. Max line length is "+Message.MAX_BODY_LINE+".")}if(_.isString(params.date)){params.date=new Date(params.date)}if(_.isNaN(params.date.getTime())){throw new Error("Invalid date.")}this.threadId=params.threadId;this.body=params.body;this.date=params.date;this.id=this._createId()});var MODEL_CLASS=Message;var STORE_NAME="message";Message.MAX_BODY_LENGTH=4096;Message.MAX_BODY_LINE=64;Message.all=function(callback){BaseModel.all(MODEL_CLASS,STORE_NAME,callback)};Message.get=function(id,callback){BaseModel.get(MODEL_CLASS,STORE_NAME,id,callback)};Message.new=function(params){return BaseModel.new(MODEL_CLASS,params)};Message.create=function(params,callback){BaseModel.create(MODEL_CLASS,params,callback)};Message.createAll=function(paramsList,callback){BaseModel.createAll(MODEL_CLASS,STORE_NAME,paramsList,function(messages){var updateParams=_.chain(messages).groupBy("threadId").map(function(messages,threadId){return{id:threadId,updatedAt:_.max(messages,function(message){return message.date}).date}}).value();var Thread=_dereq_("./Thread");Thread.update(updateParams,function(){if(callback){callback(messages)}})})};Message.delete=function(id,callback){BaseModel.delete(STORE_NAME,id,callback)};Message.deleteAll=function(callback){BaseModel.deleteAll(STORE_NAME,callback)};Message.exists=function(id,callback){BaseModel.exists(MODEL_CLASS,STORE_NAME,id,callback)};Message.where=function(cond,callback){BaseModel.where(MODEL_CLASS,STORE_NAME,cond,callback)};Message.find=function(query,callback){BaseModel.find(MODEL_CLASS,STORE_NAME,query,callback)};Message.prototype._createId=function(){return CryptoJS.SHA256(this.threadId+this.date.toISOString()+this.body).toString()};Message.prototype.save=function(callback){BaseModel.prototype.save.call(this,STORE_NAME,function(message,error){if(error){callback(null,error)}else{var Thread=_dereq_("./Thread");Thread.update([{id:message.threadId,updatedAt:message.date}],function(){callback(message)})}})};Message.prototype.exists=function(callback){Message.exists(this.id,callback)};Message.prototype.destroy=function(callback){BaseModel.prototype.destroy.call(this,STORE_NAME,callback)};Message.prototype.createProcessedMessage=function(){var message=Message.new(this.toJson());message.body=_.escape(message.body);message.body=message.body.replace(RegExp("("+_.escape(">>")+")("+"[0-9a-fA-F]+)","g"),'<a href="/thread/show?threadId='+message.threadId+'&messageId=$2">$1$2</a>');message.body=Utils.replaceCrLf(message.body);return message};Message.prototype.toJson=function(){var record=this.toRecord();return _.extend(record,{date:record.date.toISOString()})};Message.prototype.toRecord=function(){return{id:this.id,threadId:this.threadId,date:this.date,body:this.body}};module.exports=Message})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"./BaseModel":11,"./Thread":14}],13:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var BaseModel=_dereq_("./BaseModel");var Utils=_dereq_("../utils/Utils");var Setting=Utils.inherit(BaseModel,function(params){BaseModel.call(this,params);if(!Utils.isPositiveNumber(params.maxNumberOfMessagesPerThread)){throw new Error("Maximum number of messages per thread must be a positive number.")}this.maxNumberOfMessagesPerThread=params.maxNumberOfMessagesPerThread;this.id=this._createId()});var MODEL_CLASS=Setting;var STORE_NAME="setting";Setting.defaultId="setting";Setting.getDefaults=function(){return{maxNumberOfMessagesPerThread:1e3}};MODEL_CLASS.all=function(callback){BaseModel.all(MODEL_CLASS,STORE_NAME,callback)};MODEL_CLASS.get=function(id,callback){BaseModel.get(MODEL_CLASS,STORE_NAME,id,callback)};MODEL_CLASS.new=function(params){return BaseModel.new(MODEL_CLASS,params)};MODEL_CLASS.create=function(params,callback){BaseModel.create(MODEL_CLASS,params,callback)};MODEL_CLASS.createAll=function(paramsList,callback){BaseModel.createAll(MODEL_CLASS,STORE_NAME,paramsList,callback)};MODEL_CLASS.delete=function(id,callback){BaseModel.delete(STORE_NAME,id,callback)};MODEL_CLASS.deleteAll=function(callback){BaseModel.deleteAll(STORE_NAME,callback)};MODEL_CLASS.exists=function(id,callback){BaseModel.exists(MODEL_CLASS,STORE_NAME,id,callback)};MODEL_CLASS.where=function(cond,callback){BaseModel.where(MODEL_CLASS,STORE_NAME,cond,callback)};MODEL_CLASS.find=function(query,callback){BaseModel.find(MODEL_CLASS,STORE_NAME,query,callback)};MODEL_CLASS.prototype._createId=function(){return Setting.defaultId};MODEL_CLASS.prototype.save=function(callback){BaseModel.prototype.save.call(this,STORE_NAME,callback)};MODEL_CLASS.prototype.exists=function(callback){MODEL_CLASS.exists(this.id,callback)};MODEL_CLASS.prototype.destroy=function(callback){BaseModel.prototype.destroy.call(this,STORE_NAME,callback)};MODEL_CLASS.prototype.toJson=function(){var record=this.toRecord();return record};MODEL_CLASS.prototype.toRecord=function(){return{id:this.id,maxNumberOfMessagesPerThread:this.maxNumberOfMessagesPerThread}};module.exports=MODEL_CLASS})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"./BaseModel":11}],14:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var BaseModel=_dereq_("./BaseModel");var Message=_dereq_("./Message");var Utils=_dereq_("../utils/Utils");var Thread=Utils.inherit(BaseModel,function(params){BaseModel.call(this,params);if(!Utils.isNonemptyString(params.name)){throw new Error("Thread name must not be empty.")}if(_.size(params.name)>Thread.MAX_NAME_LENGTH){throw new Error("Thread name is too long. Max length is "+Thread.MAX_NAME_LENGTH+".")}if(_.isString(params.updatedAt)){params.updatedAt=new Date(params.updatedAt)}if(!_.isDate(params.updatedAt)){throw new Error("Invalid Option.")}if(_.isNaN(params.updatedAt.getTime())){throw new Error("Invalid date.")}this.name=params.name;this.updatedAt=params.updatedAt;this.id=this._createId()});var MODEL_CLASS=Thread;var STORE_NAME="thread";Thread.MAX_NAME_LENGTH=127;Thread.all=function(callback){BaseModel.all(MODEL_CLASS,STORE_NAME,callback)};Thread.get=function(id,callback){BaseModel.get(MODEL_CLASS,STORE_NAME,id,callback)};Thread.new=function(params){return BaseModel.new(MODEL_CLASS,params)};Thread.create=function(params,callback){BaseModel.create(MODEL_CLASS,params,callback)};Thread.createAll=function(paramsList,callback){BaseModel.createAll(MODEL_CLASS,STORE_NAME,paramsList,callback)};Thread.update=function(paramsList,callback){try{_.each(paramsList,function(params){Thread.new(_.extend({name:"dummy",updatedAt:new Date},params))})}catch(e){if(callback){console.log("Failed to update records:",e);callback([])}return}BaseModel.update(MODEL_CLASS,STORE_NAME,paramsList,callback)};Thread.delete=function(id,callback){BaseModel.delete(STORE_NAME,id,callback)};Thread.deleteAll=function(callback){BaseModel.deleteAll(STORE_NAME,callback)};Thread.exists=function(id,callback){BaseModel.exists(MODEL_CLASS,STORE_NAME,id,callback)};Thread.where=function(cond,callback){BaseModel.where(MODEL_CLASS,STORE_NAME,cond,callback)};Thread.find=function(query,callback){BaseModel.find(MODEL_CLASS,STORE_NAME,query,callback)};Thread.prototype._createId=function(){return CryptoJS.SHA256(this.name).toString()};Thread.prototype.save=function(callback){BaseModel.prototype.save.call(this,STORE_NAME,callback)};Thread.prototype.destroy=function(callback){BaseModel.prototype.destroy.call(this,STORE_NAME,callback)};Thread.prototype.exists=function(callback){Thread.exists(this.id,callback)};Thread.prototype.toJson=function(){var record=this.toRecord();return _.extend(record,{updatedAt:record.updatedAt.toISOString()})};Thread.prototype.toRecord=function(){return{id:this.id,name:this.name,updatedAt:this.updatedAt}};Thread.prototype.getMessages=function(callback){Message.find({threadId:this.id},callback)};Thread.prototype.createMessage=function(params,callback){Message.create(_.extend(opts,{threadId:this.id}),callback)},Thread.prototype.createMessages=function(paramsList,callback){var self=this;Message.createAll(_.map(paramsList,function(params){return _.extend(params,{threadId:self.id})}),callback)};module.exports=Thread})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"./BaseModel":11,"./Message":12}],15:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Chord=_dereq_("webrtcnet");var Request=_dereq_("./Request");var Response=_dereq_("./Response");var Utils=_dereq_("../utils/Utils");var BbsNetwork=function(config,onRequestReceivedCallback){var self=this;if(!Utils.isValidNumber(config.requestMessageTimeout)||config.requestMessageTimeout<0){config.requestMessageTimeout=18e4}this._config=config;this._chord=new Chord(config,function(fromPeerId,message){self._onMessageReceived(fromPeerId,message)});this._onRequestReceivedCallback=onRequestReceivedCallback;this._callbacks={};this._state="initialized"};BbsNetwork.prototype={createNetwork:function(callback){var self=this;if(this.getState()!=="initialized"){if(this.getState()==="failed"){callback(null,new Error("Leave network at first."))}else{callback(null,new Error("Invalid state."))}return}this._state="connecting";this._chord.create(function(peerId,error){if(error){self._state="failed"}else{self._state="connected"}callback(peerId,error)})},joinNetwork:function(bootstrapId,callback){var self=this;if(this.getState()!=="initialized"){if(this.getState()==="failed"){callback(null,new Error("Leave network at first."))}else{callback(null,new Error("Invalid state."))}return}this._state="connecting";this._chord.join(bootstrapId,function(peerId,error){if(error){self._state="failed"}else{self._state="connected"}callback(peerId,error)})},leaveNetwork:function(){this._chord.leave();this._state="initialized"},fetchThreads:function(excludeIds,callback){this._sendRequest("RECENT",{excludeIds:excludeIds},{success:function(result){if(!_.isArray(result.threadsInfo)){callback(null,new Error("Received invalid data."));return}callback(result.threadsInfo)},error:function(error){callback(null,error)}})},spreadThread:function(threadInfo){this._sendRequest("NEW",{threadInfo:threadInfo})},fetchMessages:function(threadId,excludeIds,callback){this._sendRequest("GET",{threadId:threadId,excludeIds:excludeIds},{success:function(result){if(!_.isArray(result.messagesInfo)){callback(null,new Error("Received invalid data."));return}callback(result.messagesInfo)},error:function(error){callback(null,error)}})},spreadMessage:function(messageInfo){this._sendRequest("UPDATE",{messageInfo:messageInfo})},insertEntry:function(key,value,callback){if(this.getState()!=="connected"&&this.getState()!=="listening"){if(callback){callback(new Error("Invalid state."))}return}this._chord.insert(key,value,callback)},retrieveEntries:function(key,callback){if(this.getState()!=="connected"&&this.getState()!=="listening"){if(callback){callback(null,new Error("Invalid state."))}return}this._chord.retrieve(key,callback)},removeEntry:function(key,value,callback){if(this.getState()!=="connected"&&this.getState()!=="listening"){if(callback){callback(new Error("Invalid state."))}return}this._chord.remove(key,value,callback)},_sendRequest:function(method,params,callbacks){var self=this;if(this.getState()!=="connected"){if(callbacks){callbacks.error(new Error("Invalid state."))}return}var request=Request.create(method,params);if(callbacks){var timer=setTimeout(function(){delete self._callbacks[request.requestId];callbacks.error(new Error("Request timed out."))},this._config.requestMessageTimeout);this._callbacks[request.requestId]=_.once(function(response){clearTimeout(timer);if(response.status!=="SUCCESS"){callbacks.error(new Error(response.message));return}callbacks.success(response.result)})}Utils.debug("Sending request:",request.method);try{this._chord.sendMessage(null,request.toJson())}catch(e){clearTimeout(timer);if(callbacks){callbacks.error(e)}}},_onMessageReceived:function(fromPeerId,messageJson){var self=this;if(Response.isResponse(messageJson)){var response;try{response=Response.fromJson(messageJson)}catch(e){cosole.log("Received invalid response from "+fromPeerId+": "+e);return}Utils.debug("Received response from",fromPeerId,":",response.method);if(_.has(this._callbacks,response.requestId)){var callback=this._callbacks[response.requestId];delete this._callbacks[response.requestId];callback(response)}}else if(Request.isRequest(messageJson)){var request;try{request=Request.fromJson(messageJson)}catch(e){cosole.log("Received invalid request from"+fromPeerId+": "+e);return}Utils.debug("Received request from",fromPeerId,":",request.method);this._onRequestReceivedCallback(fromPeerId,request,function(response){if(self.getState()!=="connected"){return}Utils.debug("Sending response to",fromPeerId,":",response.method,"(",response.status,")");self._chord.sendMessage(fromPeerId,response.toJson())})}},getPeerId:function(){try{return this._chord.getPeerId()}catch(e){return""}},getDirectConnectedPeers:function(){var statuses;try{statuses=this._chord.getStatuses()}catch(e){return[]}return _.chain(statuses.successors).concat([statuses.predecessor]).reject(function(peer){return!peer}).map(function(peer){return peer.peerId}).unique().value()},getState:function(){if(this._state==="connected"&&_.isEmpty(this.getDirectConnectedPeers())){return"listening"}return this._state}};module.exports=BbsNetwork})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"./Request":17,"./Response":19,webrtcnet:1}],16:[function(_dereq_,module,exports){(function(global){(function(){var $=typeof window!=="undefined"?window.$:typeof global!=="undefined"?global.$:null;var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Peer=typeof window!=="undefined"?window.Peer:typeof global!=="undefined"?global.Peer:null;var BbsNetwork=_dereq_("./BbsNetwork");var RequestDispatcher=_dereq_("./RequestDispatcher");var Utils=_dereq_("../utils/Utils");var NetworkAgent=function(config){var self=this;this._config=config;this._threadListNetwork=new BbsNetwork(this._buildConfig("T"),function(fromPeerId,request,callback){self._onRequestReceived(fromPeerId,request,callback)});this._threadNetworks={};this._requestDispatcher=new RequestDispatcher;this._peers=[]};NetworkAgent.prototype={createNetwork:function(callback){var self=this;this._threadListNetwork.createNetwork(function(peerId,error){if(error){self.leaveNetwork()}callback(peerId,error)})},joinNetwork:function(callback){var self=this;Utils.debug("Trying to join thread list network.");this._getBootstrapIds(function(bootstrapIds){self._peers=bootstrapIds;if(_.isEmpty(bootstrapIds)){self.createNetwork(callback);return}var retryJoinNetwork=function(bootstrapIds,callback){if(_.isEmpty(bootstrapIds)){self.leaveNetwork();return callback(null,new Error("Failed to join network."))}self._threadListNetwork.joinNetwork(_.first(bootstrapIds),function(peerId,error){if(error){Utils.debug("Failed to connect to",_.first(bootstrapIds),"(",error,"). Retry next peer.");retryJoinNetwork(_.rest(bootstrapIds),callback);return}Utils.debug("Joining thread list network succeeded.");callback(peerId)})};retryJoinNetwork(bootstrapIds,callback)})},leaveNetwork:function(){var self=this;this._threadListNetwork.leaveNetwork();this._threadListNetwork=new BbsNetwork(this._buildConfig("T"),function(fromPeerId,request,callback){self._onRequestReceived(fromPeerId,request,callback)});Utils.debug("Left thread list network.")},fetchThreads:function(excludeIds,callback){this._threadListNetwork.fetchThreads(excludeIds,callback)},spreadThread:function(threadInfo){this._threadListNetwork.spreadThread(threadInfo)},fetchMessages:function(threadId,excludeIds,callback){if(!_.has(this._threadNetworks,threadId)){return callback(new Error("Unknown thread ID: "+threadId))}this._threadNetworks[threadId].fetchMessages(threadId,excludeIds,callback)},spreadMessage:function(messageInfo){this._threadNetworks[messageInfo.threadId].spreadMessage(messageInfo)},joinThreadNetwork:function(threadId,callback){var self=this;if(_.has(this._threadNetworks,threadId)){return callback(this._threadNetworks[threadId].getPeerId())}Utils.debug("Trying to join thread network (thread ID",threadId,")");var threadNetwork=new BbsNetwork(this._buildConfig("t"),function(fromPeerId,request,callback){self._onRequestReceived(fromPeerId,request,callback)});this._threadNetworks[threadId]=threadNetwork;this._threadListNetwork.retrieveEntries(threadId,function(bootstrapIds,error){if(error){return callback(null,new Error("Failed to retrieve bootstrap IDs:"+error))}Utils.debug("[joinThreadNetwork] bootstrapIds:",bootstrapIds.toString());bootstrapIds=_.filter(bootstrapIds,function(id){return Utils.isNonemptyString(id)&&id.charAt(0)==="t"});if(_.isEmpty(bootstrapIds)){threadNetwork.createNetwork(function(peerId,error){if(error){threadNetwork.leaveNetwork();return callback(null,error)}Utils.debug("Created thread network (thread ID:",threadId,")");self._threadListNetwork.insertEntry(threadId,peerId);callback(peerId)});return}var retryJoinNetwork=function(bootstrapIds,callback){if(_.isEmpty(bootstrapIds)){return callback(null,new Error("No peer ID to join is left."))}threadNetwork.joinNetwork(_.first(bootstrapIds),function(peerId,error){if(error){Utils.debug("Failed to connect to "+_.first(bootstrapIds),". Retry next peer.");return retryJoinNetwork(_.rest(bootstrapIds),callback)}callback(peerId)})};retryJoinNetwork(bootstrapIds,function(peerId,error){if(error){threadNetwork.leaveNetwork();return callback(null,error)}Utils.debug("Joining thread network succeeded (thread ID:",threadId,")");self._threadListNetwork.insertEntry(threadId,peerId);callback(peerId)})})},leaveThreadNetwork:function(threadId){if(!_.has(this._threadNetworks,threadId)){throw new Error("Unknown thread ID: "+threadId)}this._threadListNetwork.removeEntry(threadId,this._threadNetworks[threadId].getPeerId());this._threadNetworks[threadId].leaveNetwork();delete this._threadNetworks[threadId];Utils.debug("Left thread network (thread ID:",threadId,")")},_buildConfig:function(prefix){var _config=_.clone(this._config);_config.peer=_.clone(this._config.peer);_config.peer.options=_.clone(this._config.peer.options);_config.peer.id=prefix+(Math.random().toString(36)+"0000000000000000000").substr(2,16);if(!_config.peer.options.host){_config.peer.options.host="localhost"}return _config},_getBootstrapIds:function(callback){var options=this._buildConfig("").peer.options;var url="http://"+options.host+":"+options.port+"/"+options.key+"/peers";$.ajax({url:url,success:function(peers){if(!_.isArray(peers)||_.isEmpty(peers)){Utils.debug("Retrieved no peer IDs.");return callback([])}Utils.debug("[_getBootstrapIds] peers:",peers);peers=_.filter(peers,function(peer){return peer.charAt(0)==="T"});callback(peers)},error:function(xhr,status,error){console.log("Failed to retrieve peers: "+error);callback([])}})},_onRequestReceived:function(fromPeerId,request,callback){this._requestDispatcher.dispatch(fromPeerId,request,callback)},getJoiningThreadIds:function(){return _.keys(this._threadNetworks)},getPeerId:function(threadId){if(!threadId){return this._threadListNetwork.getPeerId()}if(!_.has(this._threadNetworks,threadId)){throw new Error("Unknown thread ID: "+threadId)}return this._threadNetworks[threadId].getPeerId()},getPeers:function(){return this._peers},getDirectConnectedPeers:function(threadId){if(!threadId){return this._threadListNetwork.getDirectConnectedPeers()}if(!_.has(this._threadNetworks,threadId)){throw new Error("Unknown thread ID: "+threadId)}return this._threadNetworks[threadId].getDirectConnectedPeers()},getState:function(threadId){if(!threadId){return this._threadListNetwork.getState()}if(!_.has(this._threadNetworks,threadId)){throw new Error("Unknown thread ID: "+threadId)}return this._threadNetworks[threadId].getState()},checkPeerSetting:function(){if(!_.isObject(this._config.peer)){throw new Error("Property 'peer' is required in config object.")}if(!_.isObject(this._config.peer.options)){throw new Error("Property 'options' is required in config.peer object.")}if(!Utils.isNonemptyString(this._config.peer.options.host)){throw new Error("Specify the PeerServer host used in the system.")}if(!Utils.isNonemptyString(this._config.peer.options.key)){throw new Error("Specify the key for the PeerServer used in the system.")}}};module.exports=NetworkAgent})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"./BbsNetwork":15,"./RequestDispatcher":18}],17:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var CryptoJS=typeof window!=="undefined"?window.CryptoJS:typeof global!=="undefined"?global.CryptoJS:null;
var Response=_dereq_("./Response");var Utils=_dereq_("../utils/Utils");var Request=function(version,method,params,requestId,timestamp){if(!_.isArray(version)||version[0]!==Utils.version[0]){throw new Error("Incompatible version: "+version)}if(!Utils.isNonemptyString(method)||!_.isObject(params)||!Utils.isNonemptyString(requestId)||!_.isNumber(timestamp)){throw new Error("Invalid argument.")}this.version=version;this.method=method;this.params=params;this.requestId=requestId;this.timestamp=timestamp};Request.create=function(method,params){return new Request(Utils.version,method,params,Request._createId(),_.now())};Request._createId=function(){return CryptoJS.SHA256(Math.random().toString()).toString()};Request.isRequest=function(data){return!Response.isResponse(data)};Request.fromJson=function(json){if(!_.isObject(json)){throw new Error("Invalid argument.")}return new Request(json.version,json.method,json.params,json.requestId,json.timestamp)};Request.prototype={toJson:function(){return{version:this.version,method:this.method,params:this.params,requestId:this.requestId,timestamp:this.timestamp}}};module.exports=Request})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"./Response":19}],18:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Response=_dereq_("./Response");var RequestDispatcher=function(){};RequestDispatcher.prototype={dispatch:function(fromPeerId,request,callback){var self=this;switch(request.method){case"RECENT":this._routingTo("/thread/index.json",request.params,function(threadsInfo,error){if(error){console.log(error);self._sendFailureResponse("Failed to process request.",request,callback);return}self._sendSuccessResponse({threadsInfo:threadsInfo},request,callback)});break;case"NEW":this._routingTo("/thread/create.json",request.params.threadInfo);break;case"GET":this._routingTo("/thread/show.json",request.params,function(threadInfo,messagesInfo,error){if(error){console.log(error);self._sendFailureResponse("Failed to process request.",request,callback);return}self._sendSuccessResponse({messagesInfo:messagesInfo},request,callback)});break;case"UPDATE":this._routingTo("/message/create.json",request.params.messageInfo);break}},_routingTo:function(path,args,callback){WebRtcBbs.context.routing.to(path,args,true,callback)},_sendFailureResponse:function(message,request,callback){try{var response=Response.create("FAILED",{message:message},request)}catch(e){console.log(e);return}callback(response)},_sendSuccessResponse:function(result,request,callback){try{var response=Response.create("SUCCESS",result,request)}catch(e){console.log(e);return}callback(response)}};module.exports=RequestDispatcher})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./Response":19}],19:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Utils=_dereq_("../utils/Utils");var Response=function(version,status,method,result,requestId,timestamp){if(!_.isArray(version)||version[0]!==Utils.version[0]){throw new Error("Incompatible version: "+version)}if(!Utils.isNonemptyString(status)||!Utils.isNonemptyString(method)||!_.isObject(result)||!Utils.isNonemptyString(requestId)||!_.isNumber(timestamp)){throw new Error("Invalid argument.")}this.version=version;this.status=status;this.method=method;this.result=result;this.requestId=requestId;this.timestamp=timestamp};Response.create=function(status,result,request){return new Response(Utils.version,status,request.method,result,request.requestId,_.now())};Response.isResponse=function(data){if(!_.isObject(data)){return false}if(!Utils.isNonemptyString(data.status)){return false}return true};Response.fromJson=function(json){if(!_.isObject(json)){throw new Error("Invalid argument.")}return new Response(json.version,json.status,json.method,json.result,json.requestId,json.timestamp)};Response.prototype={toJson:function(){return{version:this.version,status:this.status,method:this.method,result:this.result,requestId:this.requestId,timestamp:this.timestamp}}};module.exports=Response})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24}],20:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var ThreadController=_dereq_("../controllers/ThreadController");var MessageController=_dereq_("../controllers/MessageController");var AboutController=_dereq_("../controllers/AboutController");var ContactController=_dereq_("../controllers/ContactController");var SettingsController=_dereq_("../controllers/SettingsController");var Routing=function(networkAgent){this._controllers={threadController:new ThreadController(networkAgent),messageController:new MessageController(networkAgent),aboutController:new AboutController(networkAgent),contactController:new ContactController(networkAgent),settingsController:new SettingsController(networkAgent)}};Routing.prototype={to:function(path,args,noPushState,callback){var self=this;_.defer(function(){if(!path){throw new Error("Path is not specified.")}if(args&&!_.isObject(args)){throw new Error("args expected to be a object.")}if(path==="/"){path="/thread"}var elements=path.split("/");if(elements.length<2){throw new Error("Invalid path: "+path)}elements.shift();var controller=self._controllers[elements[0]+"Controller"];if(!controller){throw new Error("Unknown controller: "+elements[0])}if(!elements[1]){elements[1]="index.html"}var elms=elements[1].split(".");var action=controller[elms[0]];if(!action){throw new Error("Unknown action: "+elms[0])}if(elms.length<2||!elms[1]){elms[1]="html"}if(!noPushState&&_.contains(["index","show"],elms[0])&&elms[1]==="html"){if(window.history){history.pushState({path:path,args:args},null)}}if(!callback){callback=function(){}}action.call(controller,args,elms[1],callback)})},reload:function(){if(window.history){var state=history.state;this.to(state.path,state.args)}}};module.exports=Routing})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../controllers/AboutController":2,"../controllers/ContactController":4,"../controllers/MessageController":5,"../controllers/SettingsController":6,"../controllers/ThreadController":7}],21:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Utils=_dereq_("../utils/Utils");var BaseTask=function(){this._timer=null};BaseTask.create=function(task,interval){var timer=setInterval(function(){task.run()},interval);task._timer=timer;return task};BaseTask.prototype={run:function(){throw new Error("Not implemented.")},shutdown:function(){clearInterval(this._timer)}};module.exports=BaseTask})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24}],22:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var BaseTask=_dereq_("./BaseTask");var Utils=_dereq_("../utils/Utils");var MaintenanceNetworkTask=Utils.inherit(BaseTask,function(networkAgent){BaseTask.call(this);this._networkAgent=networkAgent});MaintenanceNetworkTask.create=function(networkAgent,config){if(!Utils.isPositiveNumber(config.maintenanceNetworkTaskInterval)){config.maintenanceNetworkTaskInterval=3e4}return BaseTask.create(new MaintenanceNetworkTask(networkAgent),config.maintenanceNetworkTaskInterval)};MaintenanceNetworkTask.prototype.run=function(){var self=this;var maintenanceThreadNetworks=function(){var threadIds=self._networkAgent.getJoiningThreadIds();_.each(threadIds,function(threadId){if(self._networkAgent.getState(threadId)!=="connected"&&self._networkAgent.getState(threadId)!=="connecting"){self._networkAgent.leaveThreadNetwork(threadId);self._networkAgent.joinThreadNetwork(threadId,function(peerId,error){if(error){console.log("Failed to join thread network (thread ID: "+threadId+"): "+error);return}console.log("Peer ID: "+peerId)})}})};if(this._networkAgent.getState()!=="connected"&&this._networkAgent.getState()!=="connecting"){this._networkAgent.leaveNetwork();this._networkAgent.joinNetwork(function(peerId,error){if(error){console.log("Failed to join network: "+error);return}console.log("Peer ID: "+peerId);maintenanceThreadNetworks()})}else{maintenanceThreadNetworks()}};module.exports=MaintenanceNetworkTask})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../utils/Utils":24,"./BaseTask":21}],23:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var BaseTask=_dereq_("./BaseTask");var Thread=_dereq_("../models/Thread");var Message=_dereq_("../models/Message");var Utils=_dereq_("../utils/Utils");var UpdateBbsContentsTask=Utils.inherit(BaseTask,function(networkAgent){BaseTask.call(this);this._networkAgent=networkAgent});UpdateBbsContentsTask.create=function(networkAgent,config){if(!Utils.isPositiveNumber(config.updateBbsContentsTaskInterval)){config.updateBbsContentsTaskInterval=18e4}return BaseTask.create(new UpdateBbsContentsTask(networkAgent),config.updateBbsContentsTaskInterval)};UpdateBbsContentsTask.prototype.run=function(){var self=this;if(this._networkAgent.getState()==="connected"){Thread.all(function(threads,error){if(error){console.log("Failed to get threads:",error);return}self._networkAgent.fetchThreads(_.map(threads,function(thread){return thread.id}),function(threadsInfo,error){if(error){console.log("Failed to fetch threads:",error);return}Utils.debug("[UpdateBbsContentsTask] retrieved threads:",threadsInfo);Thread.createAll(threadsInfo)})})}var threadIds=this._networkAgent.getJoiningThreadIds();_.each(threadIds,function(threadId){if(self._networkAgent.getState(threadId)==="connected"){Message.find({threadId:threadId},function(messages,error){if(error){console.log("Failed to get messages:",error);return}self._networkAgent.fetchMessages(threadId,_.map(messages,function(message){return message.id}),function(messagesInfo,error){if(error){console.log("Failed to fetch messages:",error);return}Utils.debug("[UpdateBbsContentsTask] retrieved messages:",messagesInfo);Message.createAll(messagesInfo)})})}})};module.exports=UpdateBbsContentsTask})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../models/Message":12,"../models/Thread":14,"../utils/Utils":24,"./BaseTask":21}],24:[function(_dereq_,module,exports){(function(global){(function(){var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Utils={version:[0,1,0],normalizeLineFeedCode:function(str){return str.replace(/\r\n/,"\n").replace(/\r/,"\n")},replaceCrLf:function(str){return str.replace(/[\r\n]/g,"<br />")},isNonemptyString:function(value){return _.isString(value)&&!_.isEmpty(value)},isValidNumber:function(number){return _.isNumber(number)&&!_.isNaN(number)},isPositiveNumber:function(number){return Utils.isValidNumber(number)&&number>0},inherit:function(superClass,subClass){subClass.prototype=Object.create(superClass.prototype);subClass.prototype.constructor=subClass;return subClass},listRequiredFunctions:function(){return{WebRTC:!!(window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection),indexedDB:!!window.indexedDB,history:!!window.history}},parseQueryString:function(url){var split=url.split("?");if(_.size(split)<2){return{}}return _.chain(split[1].split("&")).map(function(s){return s.split("=")}).object().value()},enableDebugLog:function(enabled){Utils.debug=function(){if(enabled){var args=Array.prototype.slice.call(arguments);var d=new Date;var timeStr=[d.getHours(),d.getMinutes(),d.getSeconds()].join(":")+":";args.unshift(timeStr);console.log.apply(console,args)}}},debug:function(){}};module.exports=Utils})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],25:[function(_dereq_,module,exports){(function(global){(function(){var $=typeof window!=="undefined"?window.$:typeof global!=="undefined"?global.$:null;var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var ApplicationView=function(){if(!ApplicationView._isInitialized){ApplicationView._initialize();ApplicationView._isInitialized=true}};ApplicationView._isInitialized=false;ApplicationView._initialize=function(){$("#btn-reload").click(function(){WebRtcBbs.context.routing.reload()});$("#nav-top").click(function(){WebRtcBbs.context.routing.to("/");return false});$("#nav-about").click(function(){WebRtcBbs.context.routing.to("/about");return false});$("#nav-contact").click(function(){WebRtcBbs.context.routing.to("/contact");return false});$("#nav-settings").click(function(){WebRtcBbs.context.routing.to("/settings");return false})};ApplicationView.prototype={render:function(view){$("#contents").html(view.html.apply(view,_.rest(arguments)));view.onrendered.apply(view,_.rest(arguments))}};module.exports=ApplicationView})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],26:[function(_dereq_,module,exports){(function(global){(function(){var $=typeof window!=="undefined"?window.$:typeof global!=="undefined"?global.$:null;var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var IndexView=function(){this._template=_.template($("#template-about-index").html())};IndexView.prototype={html:function(requiredFunctions,version){return this._template({requiredFunctions:requiredFunctions,version:version})},onrendered:function(){}};module.exports=IndexView})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],27:[function(_dereq_,module,exports){(function(global){(function(){var $=typeof window!=="undefined"?window.$:typeof global!=="undefined"?global.$:null;var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var IndexView=function(){this._template=_.template($("#template-contact-index").html())};IndexView.prototype={html:function(){return this._template()},onrendered:function(){}};module.exports=IndexView})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],28:[function(_dereq_,module,exports){(function(global){(function(){var $=typeof window!=="undefined"?window.$:typeof global!=="undefined"?global.$:null;var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Utils=_dereq_("../../utils/Utils");var ShowView=function(){this._template=_.template($("#template-message-show").html())};ShowView.prototype={html:function(message){if(!message){return null}message=message.createProcessedMessage();return this._template({message:message})},onrendered:function(message){$("#a-message-show").click(function(){WebRtcBbs.context.routing.to("/message/show",{messageId:message.id});return false});$("#a-reply").click(function(){WebRtcBbs.context.routing.to("/thread/show",{threadId:message.threadId,fillInMessage:">>"+message.id.substr(0,8)+"\n"});return false});$("#btn-delete-message").click(function(){WebRtcBbs.context.routing.to("/message/delete",{messageId:message.id,threadId:message.threadId})});$("#dd-message-body a").click(function(){return false})}};module.exports=ShowView})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/Utils":24}],29:[function(_dereq_,module,exports){(function(global){(function(){var $=typeof window!=="undefined"?window.$:typeof global!=="undefined"?global.$:null;var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Utils=_dereq_("../../utils/Utils");var IndexView=function(){this._template=_.template($("#template-settings-index").html())};IndexView.prototype={html:function(state,peerId,directConnectedPeers,peers,threadsInfo,setting){if(state==="connecting"){state="Trying to connect"}return this._template({state:state,peerId:peerId,directConnectedPeers:directConnectedPeers,peers:peers,threadsInfo:threadsInfo,setting:setting})},onrendered:function(){$("button.btn-leave-thread").click(function(e){var threadId=e.target.id;WebRtcBbs.context.routing.to("/thread/leave",{threadId:threadId})});$("#btn-apply-settings").click(function(){var maxNumberOfMessagesPerThread=$("#number-max-messages-per-thread").val();maxNumberOfMessagesPerThread=parseInt(maxNumberOfMessagesPerThread);if(!Utils.isPositiveNumber(maxNumberOfMessagesPerThread)){$("#number-max-messages-per-thread").parent().parent().addClass("danger");return}WebRtcBbs.context.routing.to("/settings/update",{setting:{maxNumberOfMessagesPerThread:maxNumberOfMessagesPerThread}})})}};module.exports=IndexView})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/Utils":24}],30:[function(_dereq_,module,exports){(function(global){(function(){var $=typeof window!=="undefined"?window.$:typeof global!=="undefined"?global.$:null;var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Utils=_dereq_("../../utils/Utils");var IndexView=function(){this._template=_.template($("#template-thread-index").html())};IndexView.prototype={html:function(threads,alerts){if(!threads){threads=[]}threads=_.sortBy(threads,"updatedAt");threads.reverse();return this._template({threads:threads,alerts:alerts})},onrendered:function(threads,alerts,validator){var self=this;$("#form-create-thread").submit(function(){try{self._createThread(validator)}catch(e){console.log("Failed to create thread:",e)}return false});$("#btn-create-thread").click(function(){self._createThread(validator)});$("#thread-list a").click(function(e){var threadId=Utils.parseQueryString($(this).attr("href")).threadId;WebRtcBbs.context.routing.to("/thread/show",{threadId:threadId});return false})},_createThread:function(validator){var newThreadName=$("#text-new-thread-name").val();var params={name:newThreadName,updatedAt:new Date};var msg=validator(params);if(msg){$("#text-new-thread-name").parent("div.form-group").addClass("has-error");$("#text-new-thread-name").siblings("span.help-block").text(msg);return}WebRtcBbs.context.routing.to("/thread/create",params)}};module.exports=IndexView})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/Utils":24}],31:[function(_dereq_,module,exports){(function(global){(function(){var $=typeof window!=="undefined"?window.$:typeof global!=="undefined"?global.$:null;var _=typeof window!=="undefined"?window._:typeof global!=="undefined"?global._:null;var Utils=_dereq_("../../utils/Utils");var ShowView=function(){this._template=_.template($("#template-thread-show").html())};ShowView.prototype={html:function(thread,messages){if(!thread){return null}if(!messages){messages=[]}messages=_.sortBy(messages,"date");messages=_.map(messages,function(message){return message.createProcessedMessage()});return this._template({thread:thread,messages:messages})},onrendered:function(thread,messages,fillInMessage,validator){var self=this;$("#form-post-message").submit(function(){try{self._postMessage(thread,validator)}catch(e){console.log("Failed to post message:",e)}return false});$("#message-list a.a-message-show").click(function(){var messageId=Utils.parseQueryString($(this).attr("href")).messageId;WebRtcBbs.context.routing.to("/message/show",{messageId:messageId});return false});$("#message-list a.a-reply").click(function(){var messageId=Utils.parseQueryString($(this).attr("href")).messageId;WebRtcBbs.context.routing.to("/thread/show",{threadId:thread.id,fillInMessage:">>"+messageId.substr(0,8)+"\n"});return false});$("#message-list dd a").click(function(){var messageId=Utils.parseQueryString($(this).attr("href")).messageId;if(messageId){var targets=_.filter($("#message-list dt"),function(dt){return dt.id.indexOf(messageId)===0});if(targets.length>0){$(window).scrollTop($(targets[0]).offset().top)}return false}});$("#btn-post-message").click(function(){self._postMessage(thread,validator)});if(fillInMessage){$("#textarea-message-body").focus().val(fillInMessage);$(window).scrollTop($("#panel-post-message").offset().top)}},_postMessage:function(thread,validator){var body=$("#textarea-message-body").val();var params={threadId:thread.id,date:new Date,body:body};var msg=validator(params);if(msg){$("#textarea-message-body").parent("div.form-group").addClass("has-error");$("#textarea-message-body").siblings("span.help-block").text(msg);return}WebRtcBbs.context.routing.to("/message/create",params)}};module.exports=ShowView})()}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../../utils/Utils":24}]},{},[10])(10)});